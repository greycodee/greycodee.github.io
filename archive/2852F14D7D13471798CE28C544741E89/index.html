<!DOCTYPE html>
<html>
  <head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta name="description" content="浅水是喧哗的，深水是沉默的">
  <meta name="keyword" content="java、go、native-cloud">
  
    <link rel="shortcut icon" href="/css/images/favicon.ico">
  
  <title>
    
      MySQL是怎样通讯的？ | 打工纪实
    
  </title>
  <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/tomorrow.min.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/geopattern/1.2.3/js/geopattern.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>
  
    
<script src="/js/qrious.js"></script>

  
  
  
  
    <!-- MathJax support START -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <!-- MathJax support END -->
  


  
  
    
<script src="/js/local-search.js"></script>


<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="/atom.xml" title="打工纪实" type="application/atom+xml"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>
<div class="wechat-share">
  <!-- <img src="/css/images/logo.png" /> -->
</div>
  <body>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><header class="header fixed-header">
  <div class="header-container">
    <a class="home-link" href="/">
      <!-- <div class="logo"></div> -->
      <span>打工纪实</span>
    </a>
    <ul class="right-list">
      
        <li class="list-item">
          
            <a href="/" class="item-link">Home</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/tags/" class="item-link">Tags</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/archives/" class="item-link">Archives</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/about/" class="item-link">About</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/wikis/" class="item-link">Wiki</a>
          
        </li>
      
      
        <li class="menu-item menu-item-search right-list">
    <a role="button" class="popup-trigger">
        <i class="fa fa-search fa-fw"></i>
    </a>
</li>
      
    </ul>
    <div class="menu">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </div>
    <div class="menu-mask">
      <ul class="menu-list">
        
          <li class="menu-item">
            
              <a href="/" class="menu-link">Home</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/tags/" class="menu-link">Tags</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/archives/" class="menu-link">Archives</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/about/" class="menu-link">About</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/wikis/" class="menu-link">Wiki</a>
            
          </li>
        
      </ul>
    </div>
    
      <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
            <span class="search-icon">
                <i class="fa fa-search"></i>
            </span>
            <div class="search-input-container">
                <input autocomplete="off" autocapitalize="off"
                    placeholder="Please enter your keyword(s) to search." spellcheck="false"
                    type="search" class="search-input">
            </div>
            <span class="popup-btn-close">
                <i class="fa fa-times-circle"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>
    
  </div>
</header>

    <div id="article-banner">
  <h2>MySQL是怎样通讯的？</h2>
  <p class="post-date">2022-03-27</p>
  <div class="arrow-down">
    <a href="javascript:;" rel="external nofollow noreferrer"></a>
  </div>
</div>
<main class="app-body flex-box">
  <!-- Article START -->
  <article class="post-article">
    <section class="markdown-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>我们平常使用数据库的场景一般是程序里面代码直接连接使用，然后进行 CRUD 操作。或者使用有 GUI 界面的数据库软件来手动操作数据库， 这类软件有 DataGrip、Navicat等等…。平常很少关心它们的底层数据交互是怎么样的，相信你看了这篇文章一定能有大概的了解。本篇文章的代码使用 Go 语言来实现 MySQL 的协议。</p>
<h2 id="协议简介"><a href="#协议简介" class="headerlink" title="协议简介"></a>协议简介</h2><p>MySQL 协议一般分为两个阶段，一个是连接阶段，一个是命令阶段。<br>连接阶段主要是客户端和服务端进行相互认证的阶段，就像我们平常登陆某个网站的一个操作。<br>命令阶段主要是客户端向服务端进行的一些指令的发送，然后服务端处理指令并返回结果的一个过程。<br>在客户端和服务端发送的数据包中，前 3 个字节表示这个数据包的大小，所以这里就有一个问题，就是它有一个大小的限制，数据包大小不能超过16777215 ($2^{24}-1$) bytes，也就是 16M 大小（16进制表示：ff ff ff，刚刚 3 个字节）。这就会有三种情况出现，一种是数据包小于 16M，一种是等于，一种是大于。所以在 MySQL 协议中是这样处理的：</p>
<ul>
<li>小于 16M：发送一个数据包就可以了</li>
<li>等于 16M：发送两个数据包，第二个包为空包</li>
<li>大于 16M：发送多个数据包，每个数据包大小最大为 16M，当最后一个数据包等于 16M 时，再多发送一个空数据包</li>
</ul>
<p>每个数据包中的第 4 个字节表示这个数据包的序号ID，这个 ID 在不同阶段会递增，比如在连接阶段，这个 ID 会随着包的数量而递增，当连接阶段完成后进入命令阶段，这个 ID 又会从 0 开始递增，直到这个命令的生命周期结束。</p>
<h2 id="初始握手包"><a href="#初始握手包" class="headerlink" title="初始握手包"></a>初始握手包</h2><p>当客户端进行尝试使用 TCP 连接 MySQL 服务端时，服务端就会响应一个初始的握手包，这个握手包有 V9、V10 两个版本。不过现在一般用的都是 V10 版本，如果 MySQL 的版本在 3.21.0 之前，那么服务端响应的是 V9 版本的初始握手包。本篇文章就讲讲现在常用的 V10 版本的初始握手包。</p>
<p>我们可以使用以下代码来尝试连接我们本地的 MySQL 服务:</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;net&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>  &#123;</span><br><span class="line">	conn, err := net.Dial(<span class="string">&quot;tcp&quot;</span>,<span class="string">&quot;127.0.0.1:3306&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">(conn net.Conn)</span></span> &#123;</span><br><span class="line">		err := conn.Close()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;(conn)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>运作程序后，服务端就会响应一个初始握手包给我们，那么怎么清楚明了的查看这个数据包呢？此时我们可以用 Wireshark 这个软件来查看 MySQL 服务端返回的数据包<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e9eef1979e07465bb18236a94b2e3ba8~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"><br>可以看到前 4 个字节为 16 进制的数据: 4e 00 00 00 ，表示了这个数据包大小为 78 字节，序号 ID 为 0。具体的字段字节大小和描述如下表示：</p>
<table>
<thead>
<tr>
<th>字段名</th>
<th>字节数据长度(byte)</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>Protocol</td>
<td>1</td>
<td>初始握手包协议版本，可以根据这个字节数据来判断握手包的协议版本，然后按不同版本来处理接下来的数据</td>
</tr>
<tr>
<td>Version</td>
<td>直到遇到字节数据为 0 的时候停止</td>
<td>MySQL 服务端版本描述字符串</td>
</tr>
<tr>
<td>Thread ID</td>
<td>4</td>
<td>连接 ID</td>
</tr>
<tr>
<td>Slat（第一段）</td>
<td>8</td>
<td>用于处理后续客户端的密码加密</td>
</tr>
<tr>
<td>filler</td>
<td>1</td>
<td>填充一个字节，默认为 0</td>
</tr>
<tr>
<td>Service Capability（Low）</td>
<td>2</td>
<td>服务端能力标志，一共有 4 个字节，这里表示的是低 2 位字节的数据</td>
</tr>
<tr>
<td>Server Language</td>
<td>1</td>
<td>服务端字符编码</td>
</tr>
<tr>
<td>Server Status</td>
<td>2</td>
<td>服务端状态</td>
</tr>
<tr>
<td>Service Capability（Upper）</td>
<td>2</td>
<td>服务端能力标志，这里表示的是高 2 位字节的数据</td>
</tr>
<tr>
<td>Authentication Plugin Length</td>
<td>1</td>
<td>身份验证插件长度</td>
</tr>
<tr>
<td>Unused</td>
<td>10</td>
<td>预留的 10 个字节数据，默认全部为 0</td>
</tr>
<tr>
<td>Slat（第二段）</td>
<td>计算公式：MAX(13, 身份验证插件长度 - 8)</td>
<td>用于处理后续客户端的密码加密</td>
</tr>
<tr>
<td>Authentication Plugin</td>
<td>直到遇到字节数据为 0 的时候停止</td>
<td>身份验证插件</td>
</tr>
</tbody></table>
<p>这个初始握手包里包含了很多的数据，在后续的整个连接阶段需要用到里面的大部分数据。</p>
<h2 id="能力标志"><a href="#能力标志" class="headerlink" title="能力标志"></a>能力标志</h2><p>上面服务端响应端初始握手包中包含了一个能力标志，这个能力标志一共有 4 个字节来表示，我们知道 1 个字节有 8 个 bit，所以 4 个字节一共有 32 个 bit，其中除了最高的 7 个 bit，另外的每一个 bit 都代表着一个能力标志的状态（0 为不支持，1 为支持）,就像下面这样表示</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># Capabilities 字节数据中的低 2 位</span><br><span class="line">Server Capabilities: 0xffff</span><br><span class="line">.... .... .... ...1 = Long Password: Set</span><br><span class="line">.... .... .... ..1. = Found Rows: Set</span><br><span class="line">.... .... .... .1.. = Long Column Flags: Set</span><br><span class="line">.... .... .... 1... = Connect With Database: Set</span><br><span class="line">.... .... ...1 .... = Don&#x27;t Allow database.table.column: Set</span><br><span class="line">.... .... ..1. .... = Can use compression protocol: Set</span><br><span class="line">.... .... .1.. .... = ODBC Client: Set</span><br><span class="line">.... .... 1... .... = Can Use LOAD DATA LOCAL: Set</span><br><span class="line">.... ...1 .... .... = Ignore Spaces before &#x27;(&#x27;: Set</span><br><span class="line">.... ..1. .... .... = Speaks 4.1 protocol (new flag): Set</span><br><span class="line">.... .1.. .... .... = Interactive Client: Set</span><br><span class="line">.... 1... .... .... = Switch to SSL after handshake: Set</span><br><span class="line">...1 .... .... .... = Ignore sigpipes: Set</span><br><span class="line">..1. .... .... .... = Knows about transactions: Set</span><br><span class="line">.1.. .... .... .... = Speaks 4.1 protocol (old flag): Set</span><br><span class="line">1... .... .... .... = Can do 4.1 authentication: Set</span><br><span class="line"></span><br><span class="line"># Capabilities 字节数据中的高 2 位</span><br><span class="line">Extended Server Capabilities: 0xc1ff</span><br><span class="line">.... .... .... ...1 = Multiple statements: Set</span><br><span class="line">.... .... .... ..1. = Multiple results: Set</span><br><span class="line">.... .... .... .1.. = PS Multiple results: Set</span><br><span class="line">.... .... .... 1... = Plugin Auth: Set</span><br><span class="line">.... .... ...1 .... = Connect attrs: Set</span><br><span class="line">.... .... ..1. .... = Plugin Auth LENENC Client Data: Set</span><br><span class="line">.... .... .1.. .... = Client can handle expired passwords: Set</span><br><span class="line">.... .... 1... .... = Session variable tracking: Set</span><br><span class="line">.... ...1 .... .... = Deprecate EOF: Set</span><br><span class="line">1100 000. .... .... = Unused: 0x60</span><br></pre></td></tr></table></figure>
<p>除了服务端响应的初始握手包会返回这个能力标志，后续我们发送给服务端的 <strong>HandshakeResponse</strong> 数据包中也包含这个能力标志数据，那么我们该怎么发送这个能力标志数据呢？官方给出力各个能力的值，如下表：</p>
<table>
<thead>
<tr>
<th><strong>序号</strong></th>
<th><strong>Capability Flags</strong></th>
<th><strong>值【16进制】</strong></th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>CLIENT_LONG_PASSWORD</td>
<td>0x1</td>
</tr>
<tr>
<td>2</td>
<td>CLIENT_FOUND_ROWS</td>
<td>0x2</td>
</tr>
<tr>
<td>3</td>
<td>CLIENT_LONG_FLAG</td>
<td>0x4</td>
</tr>
<tr>
<td>4</td>
<td>CLIENT_CONNECT_WITH_DB</td>
<td>0x8</td>
</tr>
<tr>
<td>5</td>
<td>CLIENT_NO_SCHEMA</td>
<td>0x10</td>
</tr>
<tr>
<td>6</td>
<td>CLIENT_COMPRESS</td>
<td>0x20</td>
</tr>
<tr>
<td>7</td>
<td>CLIENT_ODBC</td>
<td>0x40</td>
</tr>
<tr>
<td>8</td>
<td>CLIENT_LOCAL_FILES</td>
<td>0x80</td>
</tr>
<tr>
<td>9</td>
<td>CLIENT_IGNORE_SPACE</td>
<td>0x100</td>
</tr>
<tr>
<td>10</td>
<td>CLIENT_PROTOCOL_41</td>
<td>0x200</td>
</tr>
<tr>
<td>11</td>
<td>CLIENT_INTERACTIVE</td>
<td>0x400</td>
</tr>
<tr>
<td>12</td>
<td>CLIENT_SSL</td>
<td>0x800</td>
</tr>
<tr>
<td>13</td>
<td>CLIENT_IGNORE_SIGPIPE</td>
<td>0x1000</td>
</tr>
<tr>
<td>14</td>
<td>CLIENT_TRANSACTIONS</td>
<td>0x2000</td>
</tr>
<tr>
<td>15</td>
<td>CLIENT_RESERVED</td>
<td>0x4000</td>
</tr>
<tr>
<td>16</td>
<td>CLIENT_SECURE_CONNECTION</td>
<td>0x8000</td>
</tr>
<tr>
<td>17</td>
<td>CLIENT_MULTI_STATEMENTS</td>
<td>0x10000</td>
</tr>
<tr>
<td>18</td>
<td>CLIENT_MULTI_RESULTS</td>
<td>0x20000</td>
</tr>
<tr>
<td>19</td>
<td>CLIENT_PS_MULTI_RESULTS</td>
<td>0x40000</td>
</tr>
<tr>
<td>20</td>
<td>CLIENT_PLUGIN_AUTH</td>
<td>0x80000</td>
</tr>
<tr>
<td>21</td>
<td>CLIENT_CONNECT_ATTRS</td>
<td>0x100000</td>
</tr>
<tr>
<td>22</td>
<td>CLIENT_PLUGIN_AUTH_LENENC_CLIENT_DATA</td>
<td>0x200000</td>
</tr>
<tr>
<td>23</td>
<td>CLIENT_CAN_HANDLE_EXPIRED_PASSWORDS</td>
<td>0x400000</td>
</tr>
<tr>
<td>24</td>
<td>CLIENT_SESSION_TRACK</td>
<td>0x800000</td>
</tr>
<tr>
<td>25</td>
<td>CLIENT_DEPRECATE_EOF</td>
<td>0x1000000</td>
</tr>
</tbody></table>
<p>当我们要发送客户端支持的能力标志时，只要把所有支持的能力标志的值相加，然后转换为 4 字节大小的数据。<br>例如我们要发送个给服务端说明我们支持 <strong>CLIENT_PROTOCOL_41</strong> 这个能力，那么我们就可以把这个 16 进制的值转换为 4 个字节的数据来表示，转换后的数据为：[0 0 16 0]。HEX 表示法为：[00 00 10 00]</p>
<blockquote>
<p>注意：上面转换的字节数据为小端数据，这方面端知识具体可以查询字节序的大小端</p>
</blockquote>
<h2 id="字符编码"><a href="#字符编码" class="headerlink" title="字符编码"></a>字符编码</h2><p>初始握手包还有一个字节表示了支持的字符编码，后续我们响应的 <strong>HandshakeResponse</strong> 数据包中也要发送客户端支持的字符编码，相对应的字符编码对应的 ID 如下表，当我们支持什么字符编码时，只要发送对应编码的 ID<br>就可以了。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">+--------------------+---------------------+-----+</span><br><span class="line">| CHARACTER_SET_NAME | COLLATION_NAME      | ID  |</span><br><span class="line">+--------------------+---------------------+-----+</span><br><span class="line">| big5               | big5_chinese_ci     |   <span class="number">1</span> |</span><br><span class="line">| dec8               | dec8_swedish_ci     |   <span class="number">3</span> |</span><br><span class="line">| cp850              | cp850_general_ci    |   <span class="number">4</span> |</span><br><span class="line">| hp8                | hp8_english_ci      |   <span class="number">6</span> |</span><br><span class="line">| koi8r              | koi8r_general_ci    |   <span class="number">7</span> |</span><br><span class="line">| latin1             | latin1_swedish_ci   |   <span class="number">8</span> |</span><br><span class="line">| latin2             | latin2_general_ci   |   <span class="number">9</span> |</span><br><span class="line">| swe7               | swe7_swedish_ci     |  <span class="number">10</span> |</span><br><span class="line">| ascii              | ascii_general_ci    |  <span class="number">11</span> |</span><br><span class="line">| ujis               | ujis_japanese_ci    |  <span class="number">12</span> |</span><br><span class="line">| sjis               | sjis_japanese_ci    |  <span class="number">13</span> |</span><br><span class="line">| hebrew             | hebrew_general_ci   |  <span class="number">16</span> |</span><br><span class="line">| tis620             | tis620_thai_ci      |  <span class="number">18</span> |</span><br><span class="line">| euckr              | euckr_korean_ci     |  <span class="number">19</span> |</span><br><span class="line">| koi8u              | koi8u_general_ci    |  <span class="number">22</span> |</span><br><span class="line">| gb2312             | gb2312_chinese_ci   |  <span class="number">24</span> |</span><br><span class="line">| greek              | greek_general_ci    |  <span class="number">25</span> |</span><br><span class="line">| cp1250             | cp1250_general_ci   |  <span class="number">26</span> |</span><br><span class="line">| gbk                | gbk_chinese_ci      |  <span class="number">28</span> |</span><br><span class="line">| latin5             | latin5_turkish_ci   |  <span class="number">30</span> |</span><br><span class="line">| armscii8           | armscii8_general_ci |  <span class="number">32</span> |</span><br><span class="line">| utf8               | utf8_general_ci     |  <span class="number">33</span> |</span><br><span class="line">| ucs2               | ucs2_general_ci     |  <span class="number">35</span> |</span><br><span class="line">| cp866              | cp866_general_ci    |  <span class="number">36</span> |</span><br><span class="line">| keybcs2            | keybcs2_general_ci  |  <span class="number">37</span> |</span><br><span class="line">| macce              | macce_general_ci    |  <span class="number">38</span> |</span><br><span class="line">| macroman           | macroman_general_ci |  <span class="number">39</span> |</span><br><span class="line">| cp852              | cp852_general_ci    |  <span class="number">40</span> |</span><br><span class="line">| latin7             | latin7_general_ci   |  <span class="number">41</span> |</span><br><span class="line">| cp1251             | cp1251_general_ci   |  <span class="number">51</span> |</span><br><span class="line">| utf16              | utf16_general_ci    |  <span class="number">54</span> |</span><br><span class="line">| utf16le            | utf16le_general_ci  |  <span class="number">56</span> |</span><br><span class="line">| cp1256             | cp1256_general_ci   |  <span class="number">57</span> |</span><br><span class="line">| cp1257             | cp1257_general_ci   |  <span class="number">59</span> |</span><br><span class="line">| utf32              | utf32_general_ci    |  <span class="number">60</span> |</span><br><span class="line">| binary             | binary              |  <span class="number">63</span> |</span><br><span class="line">| geostd8            | geostd8_general_ci  |  <span class="number">92</span> |</span><br><span class="line">| cp932              | cp932_japanese_ci   |  <span class="number">95</span> |</span><br><span class="line">| eucjpms            | eucjpms_japanese_ci |  <span class="number">97</span> |</span><br><span class="line">| gb18030            | gb18030_chinese_ci  | <span class="number">248</span> |</span><br><span class="line">| utf8mb4            | utf8mb4_0900_ai_ci  | <span class="number">255</span> |</span><br><span class="line">+--------------------+---------------------+-----+</span><br></pre></td></tr></table></figure>
<h2 id="客户端握手响应包（HandshakeResponse）"><a href="#客户端握手响应包（HandshakeResponse）" class="headerlink" title="客户端握手响应包（HandshakeResponse）"></a>客户端握手响应包（HandshakeResponse）</h2><p>客户端和 MySQL 服务端进行数据交互时，有明文数据交互和SSL加密数据交互，这里贴一张 MySQL 官网给出的一张图，这张图大致的描述了客户端和服务端连接的流程<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6e65f83b1bcc4b5296d913bf0ac830b1~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"><br>本篇文章就讲下简单的明文连接，不管是明文连接和加密连接，客户端都必须返回 <strong>HandshakeResponse</strong> 这个数据包给服务端。<br>这个数据包也有两个版本，一个是 <strong>HandshakeResponse41</strong>，另一个是 <strong>HandshakeResponse320</strong>。现在一般都是用 <strong>HandshakeResponse41</strong> 这个版本的数据包。那么服务端要怎么知道客户端发送的数据包到底是什么版本呢？<br>这个就要用到上面的 <strong>CLIENT_PROTOCOL_41</strong> 这个能力标志了，服务端只要解析客户端发来的 <strong>HandshakeResponse</strong> 数据包中的 Capability Flags 数据中是否支持 <strong>CLIENT_PROTOCOL_41</strong> 这个能力，来判断客户端握手响应包的版本。当 <strong>CLIENT_PROTOCOL_41</strong> 这个能力为支持状态，说明版本是 <strong>HandshakeResponse41</strong>，否则就是 <strong>HandshakeResponse320</strong>。</p>
<h3 id="HandshakeResponse41"><a href="#HandshakeResponse41" class="headerlink" title="HandshakeResponse41"></a>HandshakeResponse41</h3><p>现在常用的就是 <strong>HandshakeResponse41</strong> 这个握手响应包，本篇文章就讲一讲这个握手响应包吧。这个包的描述如下：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="number">4</span>              capability flags, CLIENT_PROTOCOL_41 always set</span><br><span class="line"><span class="number">4</span>              max-packet size</span><br><span class="line"><span class="number">1</span>              character set</span><br><span class="line">string[<span class="number">23</span>]	   <span class="built_in">reserved</span> (all [<span class="number">0</span>])</span><br><span class="line">string[NUL]    username</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> capabilities &amp; CLIENT_PLUGIN_AUTH_LENENC_CLIENT_DATA &#123;</span><br><span class="line">  <span class="comment">// 如果支持 CLIENT_PLUGIN_AUTH_LENENC_CLIENT_DATA 标志就返回这些数据</span></span><br><span class="line">  lenenc-<span class="type">int</span>     length of auth-response</span><br><span class="line">  string[n]      auth-response</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> capabilities &amp; CLIENT_SECURE_CONNECTION &#123;</span><br><span class="line">  <span class="comment">// 如果支持 CLIENT_SECURE_CONNECTION 标志就返回这些数据</span></span><br><span class="line">  <span class="number">1</span>              length of auth-response</span><br><span class="line">  string[n]      auth-response</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// 否则就返回这个数据</span></span><br><span class="line">  string[NUL]    auth-response</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> capabilities &amp; CLIENT_CONNECT_WITH_DB &#123;</span><br><span class="line">  <span class="comment">// 如果支持 CLIENT_CONNECT_WITH_DB 标志就返回这些数据</span></span><br><span class="line">  string[NUL]    database</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> capabilities &amp; CLIENT_PLUGIN_AUTH &#123;</span><br><span class="line">  <span class="comment">// 如果支持 CLIENT_PLUGIN_AUTH 标志就返回这些数据</span></span><br><span class="line">  string[NUL]    auth plugin name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> capabilities &amp; CLIENT_CONNECT_ATTRS &#123;</span><br><span class="line">  <span class="comment">// 如果支持 CLIENT_CONNECT_ATTRS 标志就返回这些数据</span></span><br><span class="line">  lenenc-<span class="type">int</span>     length of all key-values</span><br><span class="line">  lenenc-str     key</span><br><span class="line">  lenenc-str     value</span><br><span class="line">  <span class="keyword">if</span>-more data in <span class="string">&#x27;length of all key-values&#x27;</span>, more keys <span class="keyword">and</span> value pairs</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>capability_flags</strong> – 客户端的能力标志，占用 4 个字节</li>
<li><strong>max_packet_size</strong>  – 客户端要发送到服务器的命令包的最大大小，占用 4 个字节</li>
<li><strong>character_set</strong> - 连接的默认字符集，占用 1 个字节</li>
<li>username – 客户端要登录的 SQL 帐户的名称 – 此字符串应使用character set字段指示的字符集进行编码。</li>
<li><strong>auth-response</strong>  –由 auth plugin name 字段指示的 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/authentication-method.html">Authentication Method</a> 生成的加密的身份验证响应数据。</li>
<li><strong>database</strong>  – 用于连接的初始数据库 – 此字符串应使用 character set字段指示的字符集进行编码。</li>
<li>auth plugin name  – 客户端用此加密方法加密密码然后赋值给 auth-response 返回给服务端<h3 id="密码加密方式"><a href="#密码加密方式" class="headerlink" title="密码加密方式"></a>密码加密方式</h3>客户端传输给服务端的 MySQL 账户的密码加密方式采用插件的形式，就是 auth plugin name 这个字段的数据，一般支持以下几种加密方式</li>
</ul>
<table>
<thead>
<tr>
<th><strong>名称</strong></th>
<th><strong>Auth Plugin Name</strong></th>
<th><strong>能力标志</strong></th>
</tr>
</thead>
<tbody><tr>
<td>旧密码认证</td>
<td>mysql_old_password</td>
<td>不能使用，无能力标志</td>
</tr>
<tr>
<td>安全密码认证</td>
<td>mysql_native_password</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/capability-flags.html#flag-CLIENT_SECURE_CONNECTION">CLIENT_SECURE_CONNECTION</a></td>
</tr>
<tr>
<td>明文认证</td>
<td>mysql_clear_password</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/capability-flags.html#flag-CLIENT_PLUGIN_AUTH">CLIENT_PLUGIN_AUTH</a></td>
</tr>
<tr>
<td>Windows 原生身份验证</td>
<td>authentication_windows_client</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/capability-flags.html#flag-CLIENT_PLUGIN_AUTH">CLIENT_PLUGIN_AUTH</a></td>
</tr>
<tr>
<td>SHA256</td>
<td>sha256_password</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/capability-flags.html#flag-CLIENT_PLUGIN_AUTH">CLIENT_PLUGIN_AUTH</a></td>
</tr>
</tbody></table>
<p>现在一般常用的是安全密码认证，就是 <strong>Auth Plugin Name</strong> 为 mysql_native_password 的认证加密方式。这个方法的加密方式如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SHA1( password ) XOR SHA1( <span class="string">&quot;20-bytes random data from server&quot;</span> &lt;concat&gt; SHA1( SHA1( password ) ) )</span><br></pre></td></tr></table></figure>
<p>它先对明文密码进行一次 SHA1 的散列运算生成密码 1，然后再将服务端初始握手包中的 20 位 Slat 数据和对明文密码进行两次 SHA1 散列的结果进行连接，然后对连接的结果再进行一次散列运算生成密码 2，最后密码 1 和密码 2 进行异或运算，得到来最终发送给服务端的数据。</p>
<h2 id="响应数据包"><a href="#响应数据包" class="headerlink" title="响应数据包"></a>响应数据包</h2><p>当我们发送响应握手包 <strong>HandshakeResponse</strong> 后，服务端就会返回一个通用的响应包给我们，这个响应包可以是以下其中一个：</p>
<ul>
<li>OK_Packet</li>
<li>ERR_Packet</li>
<li>EOF_Packet</li>
</ul>
<p>那么我们要怎么区分这三个包呢？区分的关键在于包的第一个字节的数据，如果第一个字节数据为 0x00，则代表这是一个 OK_Packet 。如果第一个字节数据为 0xff，则表示这是一个 ERR_Packet。如果第一个字节为 0xfe，则代表这是一个 EOF_Packet。<br>从 MySQL 5.7.5 开始，OK_Packet 包也用于指示 EOF_Packet，并且不推荐使用 EOF_Packet 包。为了确保 MySQL 的旧版本（5.7.5 之前）和新版本（5.7.5 及更高版本）之间的向后兼容性，新客户端会向服务端该送 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/capability-flags.html#flag-CLIENT_DEPRECATE_EOF">CLIENT_DEPRECATE_EOF</a> 能力标志。如果没有传送这个能力标志，服务端返回端数据结果集中还是会以 EOF_Packet 包结尾，如果传送了这个能力标志的话，服务端返回端结果集中会以 OK_Packet 包结尾，并且第一个字节数据会是 0xfe。<br>那么我们怎么区分新版 OK_Packet 包在什么时候代表 OK_Packet，在什么时候代表 EOF_Packet 呢？主要可以通过以下几点来判断：</p>
<ul>
<li>一个是判断客户端刚才是否传送了 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/capability-flags.html#flag-CLIENT_DEPRECATE_EOF">CLIENT_DEPRECATE_EOF</a> 能力标志</li>
<li>OK_Packet: 第一个字节数据为 0x00，且数据包长度 &gt; 7</li>
<li>EOF_Packet: 第一个字节数据为 0xfe，且数据包长度 &lt; 9<h3 id="OK-Packet-格式"><a href="#OK-Packet-格式" class="headerlink" title="OK_Packet 格式"></a>OK_Packet 格式</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span>&lt;<span class="number">1</span>&gt;			header				[<span class="number">00</span>] <span class="keyword">or</span> [fe] the OK packet header</span><br><span class="line"><span class="type">int</span>&lt;lenenc&gt;	affected_rows		受影响行数</span><br><span class="line"><span class="type">int</span>&lt;lenenc&gt;	last_insert_id		最后插入 ID</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> capabilities &amp; CLIENT_PROTOCOL_41 &#123;</span><br><span class="line">    <span class="type">int</span>&lt;<span class="number">2</span>&gt;		status_flags	状态标志</span><br><span class="line">    <span class="type">int</span>&lt;<span class="number">2</span>&gt;		warnings		警告数</span><br><span class="line">&#125; elseif capabilities &amp; CLIENT_TRANSACTIONS &#123;</span><br><span class="line">    <span class="type">int</span>&lt;<span class="number">2</span>&gt;		status_flags	Status Flags</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> capabilities &amp; CLIENT_SESSION_TRACK &#123;</span><br><span class="line">    string&lt;lenenc&gt;	info	人类可读的状态信息</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> status_flags &amp; SERVER_SESSION_STATE_CHANGED &#123;</span><br><span class="line">        string&lt;lenenc&gt;	session_state_changes	会话状态信息</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    string&lt;EOF&gt;	info		人类可读的状态信息</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ERR-Packet-格式"><a href="#ERR-Packet-格式" class="headerlink" title="ERR_Packet 格式"></a>ERR_Packet 格式</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span>&lt;<span class="number">1</span>&gt;		header				[ff] header of the ERR packet</span><br><span class="line"><span class="type">int</span>&lt;<span class="number">2</span>&gt;		error_code			错误代码</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> capabilities &amp; CLIENT_PROTOCOL_41 &#123;</span><br><span class="line">  string&lt;<span class="number">1</span>&gt;	sql_state_marker	SQL 状态的标记</span><br><span class="line">  string&lt;<span class="number">5</span>&gt;	sql_state			SQL 状态</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">string&lt;EOF&gt;	error_message		人类可读的错误信息</span><br></pre></td></tr></table></figure>
<h3 id="EOF-Packet-格式"><a href="#EOF-Packet-格式" class="headerlink" title="EOF_Packet 格式"></a>EOF_Packet 格式</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span>&lt;<span class="number">1</span>&gt;		header				[fe] EOF header</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> capabilities &amp; CLIENT_PROTOCOL_41 &#123;</span><br><span class="line">  <span class="type">int</span>&lt;<span class="number">2</span>&gt;	warnings			警告数</span><br><span class="line">  <span class="type">int</span>&lt;<span class="number">2</span>&gt;	status_flags		状态标志</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="数据包数据类型介绍"><a href="#数据包数据类型介绍" class="headerlink" title="数据包数据类型介绍"></a>数据包数据类型介绍</h2>在上面的数据包格式中，你是不是看到例如 int&lt;1&gt;、string<EOF>、int<lenenc> 等等这些一头雾水？这个是 MySQL 官网文档中表示协议数据类型和长度的。主要数据类型如下表：</li>
</ul>
<table>
<thead>
<tr>
<th><strong>数据类型</strong></th>
<th><strong>字节长度</strong></th>
</tr>
</thead>
<tbody><tr>
<td>int&lt;1&gt;</td>
<td>1 字节</td>
</tr>
<tr>
<td>int&lt;2&gt;</td>
<td>2 字节</td>
</tr>
<tr>
<td>int&lt;3&gt;</td>
<td>3 字节</td>
</tr>
<tr>
<td>int&lt;4&gt;</td>
<td>4 字节</td>
</tr>
<tr>
<td>int&lt;6&gt;</td>
<td>6 字节</td>
</tr>
<tr>
<td>int&lt;8&gt;</td>
<td>8 字节</td>
</tr>
<tr>
<td>int&lt;lenenc&gt;</td>
<td>见下文详细介绍</td>
</tr>
<tr>
<td>string&lt;lenenc&gt;</td>
<td>见下文详细介绍</td>
</tr>
<tr>
<td>string&lt;fix&gt;</td>
<td>固定字节长度的字符串，其中 fix 代表一个指定的数值，例如 string&lt;5&gt;，其中 fix 就等于 5</td>
</tr>
<tr>
<td>string&lt;var&gt;</td>
<td>字符串的长度由另一个字段确定或在运行时计算</td>
</tr>
<tr>
<td>string&lt;EOF&gt;</td>
<td>如果字符串是数据包的最后一个组成部分，则它的长度可以从整个数据包长度减去当前位置来计算。</td>
</tr>
<tr>
<td>string&lt;NUL&gt;</td>
<td>以 [00] 字节结尾的字符串。</td>
</tr>
</tbody></table>
<p>在上面的表格中，大部分的数据类型的长度基本上都可以直接得知，但是其中 int&lt;lenenc&gt;、string&lt;lenenc&gt; 这两个类型的长度需要通过稍微复杂一点的计算来得到最终的数据长度。</p>
<h3 id="int-lt-lenenc-gt"><a href="#int-lt-lenenc-gt" class="headerlink" title="int&lt;lenenc&gt;"></a>int&lt;lenenc&gt;</h3><p>当要解析这个长度的数据时，它一般开头的第一个字节有 4 中表现形式</p>
<ul>
<li>第一个字节的值小于 0xfb：代表这个数据就是这一个字节长度，并且第一个字节的值就是对应字段的值</li>
<li>第一个字节的值等于 0xfc：代表这个字节往后的两个字节就是这个字段的数据，就是说这个字段一个占用 3 个字节长度，其中第 1 个字节表示该字段占用的字节长度数据，第 2 和第 3 个字节表示的是这个字段的数据</li>
<li>第一个字节的值等于 0xfd：和上面类似，只是字段数据字节一共占用 4 个字节，其中后 3 个字节表示这个字段的数据</li>
<li>第一个字节的值等于 0xfe：字段数据字节一共占用 9 个字节，其中后 8 个字节表示这个字段的数据<blockquote>
<p>注意：在 MySQL 3.22 版本以前，0xfe 表示的这个字段只有 4 个字节长度。<br>如果数据包的第一个字节是长度编码的整数并且其字节值为 0xfe，则必须检查数据包的长度以验证它是否有足够的空间容纳 8 字节整数。<br>如果不是，它可能是一个 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/packet-EOF_Packet.html">EOF_Packet</a> 替代。</p>
</blockquote>
</li>
</ul>
<p>所以要得到这个字段对应的字节长度时，只要判断第一个字节的数据，然后就可以轻松获得这个字段的长度了</p>
<h3 id="string-lt-lenenc-gt"><a href="#string-lt-lenenc-gt" class="headerlink" title="string&lt;lenenc&gt;"></a>string&lt;lenenc&gt;</h3><p>这个数据类型分为两部分</p>
<ul>
<li><strong>length</strong> (<a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/describing-packets.html#type-lenenc_int">int<lenenc></a>) – string 数据的占用字节长度</li>
<li><strong>string</strong> (<a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/describing-packets.html#type-string.fix_len">string<fix></a>) – [len&#x3D;$length] string</li>
</ul>
<p>其中 length 这个数据通过上面 int&lt;lenenc&gt; 的方法获得，然后 string 的数据的字节长度就是 length 的值</p>
<h2 id="发送命令"><a href="#发送命令" class="headerlink" title="发送命令"></a>发送命令</h2><p>当我们连接成功后，这时就可以向服务端发送命令了，命令如下表：</p>
<table>
<thead>
<tr>
<th><strong>HEX 值</strong></th>
<th><strong>NAME</strong></th>
</tr>
</thead>
<tbody><tr>
<td>00</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/com-sleep.html#packet-COM_SLEEP">COM_SLEEP</a></td>
</tr>
<tr>
<td>01</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/com-quit.html#packet-COM_QUIT">COM_QUIT</a></td>
</tr>
<tr>
<td>02</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/com-init-db.html#packet-COM_INIT_DB">COM_INIT_DB</a></td>
</tr>
<tr>
<td>03</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/com-query.html#packet-COM_QUERY">COM_QUERY</a></td>
</tr>
<tr>
<td>04</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/com-field-list.html#packet-COM_FIELD_LIST">COM_FIELD_LIST</a></td>
</tr>
<tr>
<td>05</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/com-create-db.html#packet-COM_CREATE_DB">COM_CREATE_DB</a></td>
</tr>
<tr>
<td>06</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/com-drop-db.html#packet-COM_DROP_DB">COM_DROP_DB</a></td>
</tr>
<tr>
<td>07</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/com-refresh.html#packet-COM_REFRESH">COM_REFRESH</a></td>
</tr>
<tr>
<td>08</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/com-shutdown.html#packet-COM_SHUTDOWN">COM_SHUTDOWN</a></td>
</tr>
<tr>
<td>09</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/com-statistics.html#packet-COM_STATISTICS">COM_STATISTICS</a></td>
</tr>
<tr>
<td>0a</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/com-process-info.html#packet-COM_PROCESS_INFO">COM_PROCESS_INFO</a></td>
</tr>
<tr>
<td>0b</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/com-connect.html#packet-COM_CONNECT">COM_CONNECT</a></td>
</tr>
<tr>
<td>0c</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/com-process-kill.html#packet-COM_PROCESS_KILL">COM_PROCESS_KILL</a></td>
</tr>
<tr>
<td>0d</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/com-debug.html#packet-COM_DEBUG">COM_DEBUG</a></td>
</tr>
<tr>
<td>0e</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/com-ping.html#packet-COM_PING">COM_PING</a></td>
</tr>
<tr>
<td>0f</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/com-time.html#packet-COM_TIME">COM_TIME</a></td>
</tr>
<tr>
<td>10</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/com-delayed-insert.html#packet-COM_DELAYED_INSERT">COM_DELAYED_INSERT</a></td>
</tr>
<tr>
<td>11</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/com-change-user.html#packet-COM_CHANGE_USER">COM_CHANGE_USER</a></td>
</tr>
<tr>
<td>12</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/com-binlog-dump.html#packet-COM_BINLOG_DUMP">COM_BINLOG_DUMP</a></td>
</tr>
<tr>
<td>13</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/com-table-dump.html#packet-COM_TABLE_DUMP">COM_TABLE_DUMP</a></td>
</tr>
<tr>
<td>14</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/com-connect-out.html#packet-COM_CONNECT_OUT">COM_CONNECT_OUT</a></td>
</tr>
<tr>
<td>15</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/com-register-slave.html#packet-COM_REGISTER_SLAVE">COM_REGISTER_SLAVE</a></td>
</tr>
<tr>
<td>16</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/com-stmt-prepare.html#packet-COM_STMT_PREPARE">COM_STMT_PREPARE</a></td>
</tr>
<tr>
<td>17</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/com-stmt-execute.html#packet-COM_STMT_EXECUTE">COM_STMT_EXECUTE</a></td>
</tr>
<tr>
<td>18</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/com-stmt-send-long-data.html#packet-COM_STMT_SEND_LONG_DATA">COM_STMT_SEND_LONG_DATA</a></td>
</tr>
<tr>
<td>19</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/com-stmt-close.html#packet-COM_STMT_CLOSE">COM_STMT_CLOSE</a></td>
</tr>
<tr>
<td>1a</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/com-stmt-reset.html#packet-COM_STMT_RESET">COM_STMT_RESET</a></td>
</tr>
<tr>
<td>1b</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/com-set-option.html#packet-COM_SET_OPTION">COM_SET_OPTION</a></td>
</tr>
<tr>
<td>1c</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/com-stmt-fetch.html#packet-COM_STMT_FETCH">COM_STMT_FETCH</a></td>
</tr>
<tr>
<td>1d</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/com-daemon.html#packet-COM_DAEMON">COM_DAEMON</a></td>
</tr>
<tr>
<td>1e</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/com-binlog-dump-gtid.html#packet-COM_BINLOG_DUMP_GTID">COM_BINLOG_DUMP_GTID</a></td>
</tr>
<tr>
<td>1f</td>
<td><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/com-reset-connection.html#packet-COM_RESET_CONNECTION">COM_RESET_CONNECTION</a></td>
</tr>
</tbody></table>
<p>一般我们用的最多的就是 COM_QUERY 这个命令，像 CRUD 都可以通过这个命令来发送，例如我们发送一个查询当前数据库，就可以发送下面的字节数据给服务端</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">0f 00 00 00 	03 73 68 6f 77 20 64 61 74 61 62 61</span><br><span class="line">73 65 73</span><br></pre></td></tr></table></figure>
<p>其中前 4 个字节代表这个包的大小和序号 ID，后面的字节数据就是我们发送的命令。<br>03 代表这个命令是 COM_QUERY。<br>后面所有的字节数据都是 show databses 转换 byte 后的字节数据</p>
<h2 id="结果集"><a href="#结果集" class="headerlink" title="结果集"></a>结果集</h2><p>当你发送的 COM_QUERY 命令时，它返回三种数据包的其中一种。我们可以通过第一个字节来判断它：</p>
<ul>
<li>当第一个字节数据等于 0x00：返回的是 OK_Packet</li>
<li>当第一个字节的数据等于 0xff：返回的是 ERR_Packet</li>
<li>当第一个字节的数据不是以上两个值时：返回一个结果集，并且第一个字节的值代表返回结果集中列（columns）的总数。</li>
</ul>
<p><strong>结果集分 3 个部分来读取：</strong></p>
<ul>
<li>第一个数据包表示返回结果集中列（columns）的总数。</li>
<li>然后通过第一个数据包获取的列总数来读取相关列的所有数据包，一列有一个数据包，比如说上面得到列总数为 3，那么接下来的 3 个数据包就是这 3 列的说明。</li>
<li>读完列的所有数据包后，紧接着就是没行数据的数据包了，一个数据包代表一行数据，每个数据包中有所有列的字段值。其中，如果值长度的值为 0xfe 时，则代表这行中这列的数据为 NULL。行数据直到读取到 OK_Packet&#x2F;EOF_Packet 包出现为止。<h3 id="COM-QUERY-Response-格式"><a href="#COM-QUERY-Response-格式" class="headerlink" title="COM_QUERY_Response 格式"></a>COM_QUERY_Response 格式</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 字节长度计算方法见上面的 int&lt;lenenc&gt; 介绍</span></span><br><span class="line"><span class="type">int</span>&lt;lenenc&gt;     结果集中列（columns）的总数。</span><br></pre></td></tr></table></figure>
<h3 id="列数据包格式"><a href="#列数据包格式" class="headerlink" title="列数据包格式"></a>列数据包格式</h3>列数据包格式也分为两种格式，也是通过客户端上传的 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/capability-flags.html#flag-CLIENT_PROTOCOL_41">CLIENT_PROTOCOL_41</a> 能力标志来觉得的。<br>如果客户端支持 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/capability-flags.html#flag-CLIENT_PROTOCOL_41">CLIENT_PROTOCOL_41</a> 这个能力标志，服务端返回 <strong>ColumnDefinition41</strong> 这个列数据包。<br>如果客户端不支持  <a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/capability-flags.html#flag-CLIENT_PROTOCOL_41">CLIENT_PROTOCOL_41</a>  这个能力标志的话，服务端就返回 <strong>ColumnDefinition320</strong> 这个版本的列数据包。<br>现在一般都使用 <strong>ColumnDefinition41</strong> 这个数据包，这个数据包描述如下：<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">string&lt;lenenc&gt;      catalog				目录 (固定为 <span class="string">&quot;def&quot;</span>)</span><br><span class="line">string&lt;lenenc&gt;      schema				数据库</span><br><span class="line">string&lt;lenenc&gt;      table				虚拟表</span><br><span class="line">string&lt;lenenc&gt;      org_table			源表</span><br><span class="line">string&lt;lenenc&gt;      name				虚拟名称</span><br><span class="line">string&lt;lenenc&gt;      org_name			源名称</span><br><span class="line">string&lt;lenenc&gt;      length of fixed-length fields [<span class="number">0</span>c]</span><br><span class="line"><span class="number">2</span>              		character set		字符集</span><br><span class="line"><span class="number">4</span>              		column length		字段的最大长度</span><br><span class="line"><span class="number">1</span>              		type				列类型</span><br><span class="line"><span class="number">2</span>              		flags				标志</span><br><span class="line"><span class="number">1</span>              		decimals			显示的小数位数</span><br><span class="line"><span class="number">2</span>              		filler [<span class="number">00</span>] [<span class="number">00</span>]	两个空占位符</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> command was COM_FIELD_LIST &#123;</span><br><span class="line">    <span class="type">int</span>&lt;lenenc&gt;     length of <span class="keyword">default</span>-values</span><br><span class="line">    string[$len]   	<span class="keyword">default</span> values</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="行数据包格式"><a href="#行数据包格式" class="headerlink" title="行数据包格式"></a>行数据包格式</h3>行数据包里面包含了所有列的字段数据，每个列的字段的数据可以通过 string&lt;lenenc&gt; 数据类型的计算的方式获得，其中要注意的是，如果字段长度描述字节的数据等于 0xfe 时，代表这行中这列的数据为 NULL。<br>下图是行数据包的表现形式：</li>
</ul>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5ee42af3f32e41739eb78d61b027987d~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"></p>
<h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><p>通过以上的介绍，现在我们可以用代码来实现不用第三方驱动的情况下手动连接 MySQL 服务器，然后发送一条查询 databses 的命令。</p>
<p><img src="https://cdn.jsdelivr.net/gh/greycodee/images@main/images/2022/03/28/Untitled-2022-02-10-1029.png" alt="Untitled-2022-02-10-1029"></p>
<p>下面的是代码片段，完整代码连接：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://gist.github.com/greycodee/22f98464fece7792a83433a1fba58e2a">https://gist.github.com/greycodee/22f98464fece7792a83433a1fba58e2a</a></p>
<h3 id="连接-MySQL-服务器"><a href="#连接-MySQL-服务器" class="headerlink" title="连接 MySQL 服务器"></a>连接 MySQL 服务器</h3><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> MySQLClient <span class="keyword">struct</span> &#123;</span><br><span class="line">	conn net.Conn</span><br><span class="line">	addr <span class="type">string</span></span><br><span class="line">	username <span class="type">string</span></span><br><span class="line">	password	<span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *MySQLClient)</span></span> init()  &#123;</span><br><span class="line">	<span class="comment">// 连接阶段</span></span><br><span class="line">	handshake := m.startConn()</span><br><span class="line">	m.sendHandshakeResponse41(handshake)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	连接 MySQL 服务器</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *MySQLClient)</span></span> startConn() *HandshakeV10 &#123;</span><br><span class="line">	m.conn, _ = net.Dial(<span class="string">&quot;tcp&quot;</span>,m.addr)</span><br><span class="line">	initResp := <span class="built_in">make</span>([]<span class="type">byte</span>,<span class="number">1024</span>)</span><br><span class="line">	readLen, _ := m.conn.Read(initResp)</span><br><span class="line">	<span class="keyword">return</span> ReadHandShakeV10(initResp[:readLen])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="解析初始握手数据包"><a href="#解析初始握手数据包" class="headerlink" title="解析初始握手数据包"></a>解析初始握手数据包</h3><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	解析初始握手包 HandShakeV10</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadHandShakeV10</span><span class="params">(data []<span class="type">byte</span>)</span></span> *HandshakeV10 &#123;</span><br><span class="line">	index := <span class="number">0</span></span><br><span class="line">	<span class="keyword">var</span> h = &amp;HandshakeV10&#123;&#125;</span><br><span class="line">	index+=<span class="number">4</span></span><br><span class="line">	h.ProtocolVersion= <span class="type">int32</span>(data[index])</span><br><span class="line">	index++</span><br><span class="line">	<span class="keyword">var</span> serverVersion []<span class="type">byte</span></span><br><span class="line">	<span class="keyword">for</span> data[index]!=<span class="number">0</span> &#123;</span><br><span class="line">		serverVersion = <span class="built_in">append</span>(serverVersion,data[index])</span><br><span class="line">		index++</span><br><span class="line">	&#125;</span><br><span class="line">	h.ServerVersion = <span class="type">string</span>(serverVersion)</span><br><span class="line">	index++</span><br><span class="line">	connectByte := data[index:index+<span class="number">4</span>]</span><br><span class="line">	<span class="keyword">for</span> i :=<span class="keyword">range</span> connectByte&#123;</span><br><span class="line">		h.ConnectionId+=<span class="type">int32</span>(connectByte[i])</span><br><span class="line">	&#125;</span><br><span class="line">	index+=<span class="number">4</span></span><br><span class="line">	<span class="keyword">var</span> apdp1 []<span class="type">byte</span></span><br><span class="line">	apdp1Byte := data[index:index+<span class="number">8</span>]</span><br><span class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> apdp1Byte &#123;</span><br><span class="line">		apdp1 = <span class="built_in">append</span>(apdp1, apdp1Byte[i])</span><br><span class="line">	&#125;</span><br><span class="line">	h.AuthPluginDataPart_1 = <span class="type">string</span>(apdp1)</span><br><span class="line">	index+=<span class="number">9</span></span><br><span class="line">	<span class="comment">// 能力低2位</span></span><br><span class="line">	c_flag_low_1 := strings.Split(fmt.Sprintf(<span class="string">&quot;%b\n&quot;</span>,data[index+<span class="number">1</span>]),<span class="string">&quot;&quot;</span>)</span><br><span class="line">	c_flag_low_2 := strings.Split(fmt.Sprintf(<span class="string">&quot;%b\n&quot;</span>,data[index]),<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">	index+=<span class="number">2</span></span><br><span class="line">	<span class="comment">// 编码获取</span></span><br><span class="line">	h.CharacterSet = <span class="type">int32</span>(data[index])</span><br><span class="line">	index++</span><br><span class="line">	<span class="comment">// 服务器状态</span></span><br><span class="line">	index+=<span class="number">2</span></span><br><span class="line">	<span class="comment">// 能力高2位</span></span><br><span class="line">	c_flag_up_1 := strings.Split(fmt.Sprintf(<span class="string">&quot;%b\n&quot;</span>,data[index+<span class="number">1</span>]),<span class="string">&quot;&quot;</span>)</span><br><span class="line">	c_flag_up_2 := strings.Split(fmt.Sprintf(<span class="string">&quot;%b\n&quot;</span>,data[index]),<span class="string">&quot;&quot;</span>)</span><br><span class="line">	<span class="keyword">var</span> capabilityFlags []<span class="type">string</span></span><br><span class="line">	capabilityFlags = <span class="built_in">append</span>(capabilityFlags,c_flag_up_1...)</span><br><span class="line">	capabilityFlags = <span class="built_in">append</span>(capabilityFlags,c_flag_up_2...)</span><br><span class="line">	capabilityFlags = <span class="built_in">append</span>(capabilityFlags,c_flag_low_1...)</span><br><span class="line">	capabilityFlags = <span class="built_in">append</span>(capabilityFlags,c_flag_low_2...)</span><br><span class="line">	index+=<span class="number">2</span></span><br><span class="line">	<span class="keyword">if</span> strings.EqualFold(<span class="string">&quot;1&quot;</span>,capabilityFlags[<span class="number">19</span>])&#123;</span><br><span class="line">		h.AuthPluginDataLen= <span class="type">int32</span>(data[index])</span><br><span class="line">	&#125;</span><br><span class="line">	index++</span><br><span class="line">	index+=<span class="number">10</span></span><br><span class="line">	<span class="keyword">if</span> strings.EqualFold(<span class="string">&quot;1&quot;</span>,capabilityFlags[<span class="number">15</span>])&#123;</span><br><span class="line">		p2Len := <span class="number">13</span></span><br><span class="line">		p2len1 := <span class="type">int</span>(h.AuthPluginDataLen<span class="number">-8</span>)</span><br><span class="line">		<span class="keyword">if</span> p2Len &lt; p2len1 &#123;</span><br><span class="line">			p2Len = p2len1</span><br><span class="line">		&#125;</span><br><span class="line">		h.AuthPluginDataPart_2 = <span class="type">string</span>(data[index:index+p2Len])</span><br><span class="line">		index+=p2Len</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> strings.EqualFold(<span class="string">&quot;1&quot;</span>,capabilityFlags[<span class="number">19</span>]) &#123;</span><br><span class="line">		<span class="keyword">var</span> authPlugName []<span class="type">byte</span></span><br><span class="line">		<span class="keyword">for</span> data[index] != <span class="number">0</span> &#123;</span><br><span class="line">			authPlugName = <span class="built_in">append</span>(authPlugName,data[index])</span><br><span class="line">			index++</span><br><span class="line">		&#125;</span><br><span class="line">		h.AuthPluginName = <span class="type">string</span>(authPlugName)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> h</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> HandshakeV10 <span class="keyword">struct</span> &#123;</span><br><span class="line">	ProtocolVersion      <span class="type">int32</span>  <span class="string">`protobuf:&quot;varint,1,opt,name=protocol_version,json=protocolVersion,proto3&quot; json:&quot;protocol_version,omitempty&quot;`</span></span><br><span class="line">	ServerVersion        <span class="type">string</span> <span class="string">`protobuf:&quot;bytes,2,opt,name=server_version,json=serverVersion,proto3&quot; json:&quot;server_version,omitempty&quot;`</span></span><br><span class="line">	ConnectionId         <span class="type">int32</span>  <span class="string">`protobuf:&quot;varint,3,opt,name=connection_id,json=connectionId,proto3&quot; json:&quot;connection_id,omitempty&quot;`</span></span><br><span class="line">	AuthPluginDataPart_1 <span class="type">string</span> <span class="string">`protobuf:&quot;bytes,4,opt,name=auth_plugin_data_part_1,json=authPluginDataPart1,proto3&quot; json:&quot;auth_plugin_data_part_1,omitempty&quot;`</span></span><br><span class="line">	CharacterSet         <span class="type">int32</span>  <span class="string">`protobuf:&quot;varint,6,opt,name=character_set,json=characterSet,proto3&quot; json:&quot;character_set,omitempty&quot;`</span></span><br><span class="line">	StatusFlags          <span class="type">int32</span>  <span class="string">`protobuf:&quot;varint,7,opt,name=status_flags,json=statusFlags,proto3&quot; json:&quot;status_flags,omitempty&quot;`</span></span><br><span class="line">	AuthPluginDataLen    <span class="type">int32</span>  <span class="string">`protobuf:&quot;varint,8,opt,name=auth_plugin_data_len,json=authPluginDataLen,proto3&quot; json:&quot;auth_plugin_data_len,omitempty&quot;`</span></span><br><span class="line">	AuthPluginDataPart_2 <span class="type">string</span> <span class="string">`protobuf:&quot;bytes,9,opt,name=auth_plugin_data_part_2,json=authPluginDataPart2,proto3&quot; json:&quot;auth_plugin_data_part_2,omitempty&quot;`</span></span><br><span class="line">	AuthPluginName       <span class="type">string</span> <span class="string">`protobuf:&quot;bytes,10,opt,name=auth_plugin_name,json=authPluginName,proto3&quot; json:&quot;auth_plugin_name,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="发送初始响应数据包"><a href="#发送初始响应数据包" class="headerlink" title="发送初始响应数据包"></a>发送初始响应数据包</h3><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	发送初始响应数据包 HandshakeResponse41，包含登陆信息</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *MySQLClient)</span></span> sendHandshakeResponse41(serverResp *HandshakeV10) &#123;</span><br><span class="line">	resp := <span class="built_in">make</span>([]<span class="type">byte</span>,<span class="number">0</span>)</span><br><span class="line">	resp = <span class="built_in">append</span>(resp, Int32ToBytesOfLittle(<span class="number">19833351</span>)...)</span><br><span class="line">	resp = <span class="built_in">append</span>(resp, Int32ToBytesOfLittle(<span class="number">16777215</span>)...)</span><br><span class="line">	resp = <span class="built_in">append</span>(resp, <span class="number">33</span>)</span><br><span class="line">	reserved := <span class="built_in">make</span>([]<span class="type">byte</span>,<span class="number">23</span>)</span><br><span class="line">	resp = <span class="built_in">append</span>(resp, reserved...)</span><br><span class="line">	resp = <span class="built_in">append</span>(resp, []<span class="type">byte</span>(m.username)...)</span><br><span class="line">	resp = <span class="built_in">append</span>(resp, <span class="number">0</span>)</span><br><span class="line">	resp = <span class="built_in">append</span>(resp, <span class="number">20</span>)</span><br><span class="line">	resp = <span class="built_in">append</span>(resp, CalcPassword([]<span class="type">byte</span>(serverResp.AuthPluginDataPart_1+serverResp.AuthPluginDataPart_2)[:<span class="number">20</span>],[]<span class="type">byte</span>(m.password))...)</span><br><span class="line">	resp = <span class="built_in">append</span>(resp, []<span class="type">byte</span>(<span class="string">&quot;mysql_native_password&quot;</span>)...)</span><br><span class="line">	resp = <span class="built_in">append</span>(resp, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">	_, _ = m.conn.Write(Pack(resp,<span class="number">1</span>))</span><br><span class="line">	flag := m.handleResponse()</span><br><span class="line">	<span class="keyword">if</span> flag == <span class="number">0xff</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">&quot;连接失败&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="判断连接结果"><a href="#判断连接结果" class="headerlink" title="判断连接结果"></a>判断连接结果</h3><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	解析通用响应数据包 OK_Packet、ERR_Packet、数据集</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *MySQLClient)</span></span> handleResponse() <span class="type">uint8</span> &#123;</span><br><span class="line">	resp := <span class="built_in">make</span>([]<span class="type">byte</span>,<span class="number">1024</span>)</span><br><span class="line">	readLen, _ := m.conn.Read(resp)</span><br><span class="line">	data := resp[:readLen]</span><br><span class="line">	data = data[<span class="number">4</span>:]</span><br><span class="line">	<span class="keyword">switch</span> data[<span class="number">0</span>] &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">0x00</span>:</span><br><span class="line">		fmt.Println(<span class="string">&quot;成功&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0x00</span></span><br><span class="line">	<span class="keyword">case</span> <span class="number">0xff</span>:</span><br><span class="line">		fmt.Println(<span class="string">&quot;失败&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0xff</span></span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		parseResultSet(data)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0xfe</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="发送命令-1"><a href="#发送命令-1" class="headerlink" title="发送命令"></a>发送命令</h3><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	CommandQuery</span></span><br><span class="line"><span class="comment">	发送 COM_QUERY 命令，并读取数据</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *MySQLClient)</span></span> CommandQuery(sql <span class="type">string</span>) &#123;</span><br><span class="line">	resp := <span class="built_in">make</span>([]<span class="type">byte</span>,<span class="number">0</span>)</span><br><span class="line">	resp = <span class="built_in">append</span>(resp, <span class="number">3</span>)</span><br><span class="line">	resp = <span class="built_in">append</span>(resp, []<span class="type">byte</span>(sql)...)</span><br><span class="line">	_, _ = m.conn.Write(Pack(resp,<span class="number">0</span>))</span><br><span class="line">	m.handleResponse()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="解析结果集"><a href="#解析结果集" class="headerlink" title="解析结果集"></a>解析结果集</h3><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">parseResultSet</span><span class="params">(resp []<span class="type">byte</span>)</span></span>  &#123;</span><br><span class="line">	index := <span class="number">0</span></span><br><span class="line">	fieldLen := resp[<span class="number">0</span>]</span><br><span class="line">	index+=<span class="number">1</span></span><br><span class="line">	headRows := <span class="built_in">make</span>([]<span class="type">string</span>,<span class="number">0</span>)</span><br><span class="line">	headIndex := <span class="number">1</span></span><br><span class="line">	<span class="comment">// 读取列数据</span></span><br><span class="line">	<span class="keyword">for</span> headIndex &lt;= <span class="type">int</span>(fieldLen)&#123;</span><br><span class="line">		n,l := readColumn(resp,index)</span><br><span class="line">		index+=l</span><br><span class="line">		headRows = <span class="built_in">append</span>(headRows, n)</span><br><span class="line">		headIndex++</span><br><span class="line">	&#125;</span><br><span class="line">	table, err := gotable.Create(headRows...)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;Create table failed: &quot;</span>, err.Error())</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 读取行内容</span></span><br><span class="line">	<span class="keyword">for</span>  &#123;</span><br><span class="line">		<span class="comment">// 判断是否是 EOF 数据包</span></span><br><span class="line">		<span class="keyword">if</span> resp[index+<span class="number">4</span>] == <span class="number">0xfe</span>&#123;</span><br><span class="line">			packLen := <span class="number">0</span></span><br><span class="line">			<span class="keyword">for</span> _,v :=<span class="keyword">range</span> resp[index:index+<span class="number">3</span>]&#123;</span><br><span class="line">				packLen+=<span class="type">int</span>(v)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> packLen&lt;<span class="number">9</span> &#123;</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		rows,ll := readRow(resp,index, <span class="type">int</span>(fieldLen))</span><br><span class="line">		table.AddRow(rows)</span><br><span class="line">		index+=ll</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 打印</span></span><br><span class="line">	fmt.Println(table)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readColumn</span><span class="params">(data []<span class="type">byte</span>, startIndex <span class="type">int</span>)</span></span> (name <span class="type">string</span>,length <span class="type">int</span>) &#123;</span><br><span class="line">	packLen := data[startIndex:startIndex+<span class="number">3</span>]</span><br><span class="line">	<span class="keyword">for</span> i :=<span class="keyword">range</span> packLen&#123;</span><br><span class="line">		length+=<span class="type">int</span>(packLen[i])</span><br><span class="line">	&#125;</span><br><span class="line">	length += <span class="number">4</span></span><br><span class="line"></span><br><span class="line">	startIndex+=<span class="number">4</span></span><br><span class="line">	startIndex+=<span class="type">int</span>(data[startIndex]+<span class="number">1</span>)</span><br><span class="line">	startIndex+=<span class="type">int</span>(data[startIndex]+<span class="number">1</span>)</span><br><span class="line">	startIndex+=<span class="type">int</span>(data[startIndex]+<span class="number">1</span>)</span><br><span class="line">	startIndex+=<span class="type">int</span>(data[startIndex]+<span class="number">1</span>)</span><br><span class="line">	nameLen := <span class="type">int</span>(data[startIndex])</span><br><span class="line">	name = <span class="type">string</span>(data[startIndex+<span class="number">1</span>:startIndex+nameLen+<span class="number">1</span>])</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readRow</span><span class="params">(data []<span class="type">byte</span>, startIndex <span class="type">int</span>, fieldNum <span class="type">int</span>)</span></span> (name []<span class="type">string</span>,length <span class="type">int</span>) &#123;</span><br><span class="line">	packLen := data[startIndex:startIndex+<span class="number">3</span>]</span><br><span class="line">	<span class="keyword">for</span> i :=<span class="keyword">range</span> packLen&#123;</span><br><span class="line">		length+=<span class="type">int</span>(packLen[i])</span><br><span class="line">	&#125;</span><br><span class="line">	length += <span class="number">4</span></span><br><span class="line">	startIndex+=<span class="number">4</span></span><br><span class="line">	f:=<span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> f &lt; fieldNum&#123;</span><br><span class="line">		dataLen := <span class="number">0</span></span><br><span class="line">		<span class="comment">// 计算字节数据长度</span></span><br><span class="line">		<span class="keyword">if</span> data[startIndex] &lt; <span class="number">0xfb</span> &#123;</span><br><span class="line">			<span class="comment">// NULL</span></span><br><span class="line">			dataLen = <span class="type">int</span>(data[startIndex])</span><br><span class="line">		&#125;<span class="keyword">else</span> <span class="keyword">if</span> data[startIndex] == <span class="number">0xfc</span> &#123;</span><br><span class="line">			<span class="keyword">for</span> _,v := <span class="keyword">range</span> data[startIndex+<span class="number">1</span>:startIndex+<span class="number">3</span>]&#123;</span><br><span class="line">				dataLen+=<span class="type">int</span>(v)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;<span class="keyword">else</span> <span class="keyword">if</span> data[startIndex] == <span class="number">0xfd</span> &#123;</span><br><span class="line">			<span class="keyword">for</span> _,v :=<span class="keyword">range</span> data[startIndex+<span class="number">1</span>:startIndex+<span class="number">5</span>]&#123;</span><br><span class="line">				dataLen+=<span class="type">int</span>(v)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;<span class="keyword">else</span> <span class="keyword">if</span> data[startIndex] == <span class="number">0xfe</span> &#123;</span><br><span class="line">			<span class="keyword">for</span> _,v :=<span class="keyword">range</span> data[startIndex+<span class="number">1</span>:startIndex+<span class="number">9</span>]&#123;</span><br><span class="line">				dataLen+=<span class="type">int</span>(v)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		name = <span class="built_in">append</span>(name, <span class="type">string</span>(data[startIndex+<span class="number">1</span>:startIndex+dataLen+<span class="number">1</span>]))</span><br><span class="line">		startIndex += dataLen+<span class="number">1</span></span><br><span class="line">		f++</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="控制台结果输出"><a href="#控制台结果输出" class="headerlink" title="控制台结果输出"></a>控制台结果输出</h3><p>执行上面的代码后，控制台就会输出所有的数据库名字</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">+--------------------+</span><br><span class="line">|      Database      |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">|      greycode      |</span><br><span class="line">|       mysql        |</span><br><span class="line">| performance_schema |</span><br><span class="line">|        sys         |</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://dev.mysql.com/doc/internals/en/client-server-protocol.html">https://dev.mysql.com/doc/internals/en/client-server-protocol.html</a></p>
</section>
    <!-- Tags START -->
    
      <div class="tags">
        <span>Tags:</span>
        
  <a href="/tags#协议" >
    <span class="tag-code">协议</span>
  </a>

  <a href="/tags#MySQL" >
    <span class="tag-code">MySQL</span>
  </a>

      </div>
    
    <!-- Tags END -->
    <!-- NAV START -->
    
  <div class="nav-container">
    <!-- reverse left and right to put prev and next in a more logic postition -->
    
      <a class="nav-left" href="/archive/FA21243A47644D98B4380AE439D2A69F/">
        <span class="nav-arrow">← </span>
        
          什么是P2P网络
        
      </a>
    
    
      <a class="nav-right" href="/archive/8B135153FD9D41DE928DF42F84AD1ECA/">
        
          Redis是怎样通讯的？
        
        <span class="nav-arrow"> →</span>
      </a>
    
  </div>

    <!-- NAV END -->
    <!-- 打赏 START -->
    
    <!-- 打赏 END -->
    <!-- 二维码 START -->
    
      <div class="qrcode">
        <canvas id="share-qrcode"></canvas>
        <p class="notice">扫描二维码，分享此文章</p>
      </div>
    
    <!-- 二维码 END -->
    
      <!-- Utterances START -->
      <div id="utterances"></div>
      <script src="https://utteranc.es/client.js"
        repo=""
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async></script>    
      <!-- Utterances END -->
    
  </article>
  <!-- Article END -->
  <!-- Catalog START -->
  
    <aside class="catalog-container">
  <div class="toc-main">
    <strong class="toc-title">Catalog</strong>
    
      <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-nav-text">前言</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%8D%8F%E8%AE%AE%E7%AE%80%E4%BB%8B"><span class="toc-nav-text">协议简介</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%88%9D%E5%A7%8B%E6%8F%A1%E6%89%8B%E5%8C%85"><span class="toc-nav-text">初始握手包</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E8%83%BD%E5%8A%9B%E6%A0%87%E5%BF%97"><span class="toc-nav-text">能力标志</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81"><span class="toc-nav-text">字符编码</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8F%A1%E6%89%8B%E5%93%8D%E5%BA%94%E5%8C%85%EF%BC%88HandshakeResponse%EF%BC%89"><span class="toc-nav-text">客户端握手响应包（HandshakeResponse）</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#HandshakeResponse41"><span class="toc-nav-text">HandshakeResponse41</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%AF%86%E7%A0%81%E5%8A%A0%E5%AF%86%E6%96%B9%E5%BC%8F"><span class="toc-nav-text">密码加密方式</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%93%8D%E5%BA%94%E6%95%B0%E6%8D%AE%E5%8C%85"><span class="toc-nav-text">响应数据包</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#OK-Packet-%E6%A0%BC%E5%BC%8F"><span class="toc-nav-text">OK_Packet 格式</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#ERR-Packet-%E6%A0%BC%E5%BC%8F"><span class="toc-nav-text">ERR_Packet 格式</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#EOF-Packet-%E6%A0%BC%E5%BC%8F"><span class="toc-nav-text">EOF_Packet 格式</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E6%95%B0%E6%8D%AE%E5%8C%85%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%BB%8B%E7%BB%8D"><span class="toc-nav-text">数据包数据类型介绍</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#int-lt-lenenc-gt"><span class="toc-nav-text">int&lt;lenenc&gt;</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#string-lt-lenenc-gt"><span class="toc-nav-text">string&lt;lenenc&gt;</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%8F%91%E9%80%81%E5%91%BD%E4%BB%A4"><span class="toc-nav-text">发送命令</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E7%BB%93%E6%9E%9C%E9%9B%86"><span class="toc-nav-text">结果集</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#COM-QUERY-Response-%E6%A0%BC%E5%BC%8F"><span class="toc-nav-text">COM_QUERY_Response 格式</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%88%97%E6%95%B0%E6%8D%AE%E5%8C%85%E6%A0%BC%E5%BC%8F"><span class="toc-nav-text">列数据包格式</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%8C%85%E6%A0%BC%E5%BC%8F"><span class="toc-nav-text">行数据包格式</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-nav-text">代码实现</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E8%BF%9E%E6%8E%A5-MySQL-%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-nav-text">连接 MySQL 服务器</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E8%A7%A3%E6%9E%90%E5%88%9D%E5%A7%8B%E6%8F%A1%E6%89%8B%E6%95%B0%E6%8D%AE%E5%8C%85"><span class="toc-nav-text">解析初始握手数据包</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%8F%91%E9%80%81%E5%88%9D%E5%A7%8B%E5%93%8D%E5%BA%94%E6%95%B0%E6%8D%AE%E5%8C%85"><span class="toc-nav-text">发送初始响应数据包</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%88%A4%E6%96%AD%E8%BF%9E%E6%8E%A5%E7%BB%93%E6%9E%9C"><span class="toc-nav-text">判断连接结果</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%8F%91%E9%80%81%E5%91%BD%E4%BB%A4-1"><span class="toc-nav-text">发送命令</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E8%A7%A3%E6%9E%90%E7%BB%93%E6%9E%9C%E9%9B%86"><span class="toc-nav-text">解析结果集</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E6%8E%A7%E5%88%B6%E5%8F%B0%E7%BB%93%E6%9E%9C%E8%BE%93%E5%87%BA"><span class="toc-nav-text">控制台结果输出</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-nav-text">参考资料</span></a></li></ol>
    
  </div>
</aside>
  
  <!-- Catalog END -->
</main>

<script>
  (function () {
    var url = 'https://greycode.top/archive/2852F14D7D13471798CE28C544741E89/';
    var banner = ''
    if (banner !== '' && banner !== 'undefined' && banner !== 'null') {
      $('#article-banner').css({
        'background-image': 'url(' + banner + ')'
      })
    } else {
      $('#article-banner').geopattern(url)
    }
    $('.header').removeClass('fixed-header')

    // error image
    $(".markdown-content img").on('error', function() {
      $(this).attr('src', '/css/images/error_icon.png')
      $(this).css({
        'cursor': 'default'
      })
    })

    // zoom image
    $(".markdown-content img").on('click', function() {
      var src = $(this).attr('src')
      if (src !== '/css/images/error_icon.png') {
        var imageW = $(this).width()
        var imageH = $(this).height()

        var zoom = ($(window).width() * 0.95 / imageW).toFixed(2)
        zoom = zoom < 1 ? 1 : zoom
        zoom = zoom > 2 ? 2 : zoom
        var transY = (($(window).height() - imageH) / 2).toFixed(2)

        $('body').append('<div class="image-view-wrap"><div class="image-view-inner"><img src="'+ src +'" /></div></div>')
        $('.image-view-wrap').addClass('wrap-active')
        $('.image-view-wrap img').css({
          'width': `${imageW}`,
          'transform': `translate3d(0, ${transY}px, 0) scale3d(${zoom}, ${zoom}, 1)`
        })
        $('html').css('overflow', 'hidden')

        $('.image-view-wrap').on('click', function() {
          $(this).remove()
          $('html').attr('style', '')
        })
      }
    })
  })();
</script>


  <script>
    var qr = new QRious({
      element: document.getElementById('share-qrcode'),
      value: document.location.href
    });
  </script>






    <div class="scroll-top">
  <span class="arrow-icon"></span>
</div>
    <footer class="app-footer">
  <p class="copyright">
    &copy; 2022 | Proudly powered by <a href="https://hexo.io" rel="external nofollow noreferrer" target="_blank">Hexo</a>
    <br>
    Theme by <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/yanm1ng">yanm1ng</a>
  </p>
</footer>

<script>
  function async(u, c) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }
</script>
<script>
  async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
    FastClick.attach(document.body);
  })
</script>

<script>
  var hasLine = 'false';
  async("//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js", function(){
    $('figure pre').each(function(i, block) {
      var figure = $(this).parents('figure');
      if (hasLine === 'false') {
        figure.find('.gutter').hide();
      }
      hljs.configure({useBR: true});
      var lang = figure.attr('class').split(' ')[1] || 'code';
      var codeHtml = $(this).html();
      var codeTag = document.createElement('code');
      codeTag.className = lang;
      codeTag.innerHTML = codeHtml;
      $(this).attr('class', '').empty().html(codeTag);
      figure.attr('data-lang', lang.toUpperCase());
      hljs.highlightBlock(block);
    });
  })
</script>
<!-- Baidu Tongji -->


<script src="/js/script.js"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->


  </body>
</html>