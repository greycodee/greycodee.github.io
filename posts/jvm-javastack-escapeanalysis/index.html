<!doctype html><html lang=en-us><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><script type=text/javascript src=https://latest.cactus.chat/cactus.js></script>
<link rel=stylesheet href=https://latest.cactus.chat/style.css type=text/css><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>JVM逃逸分析技术 | Greycode's Blog</title><link rel=canonical href=https://greycode.top/posts/jvm-javastack-escapeanalysis/><meta name=description content="Hello,I‘m Greycode. Please use Chrome to browse this site for a better experience."><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="JVM逃逸分析技术"><meta property="og:description" content="逃逸分析技术的日渐成熟,促使所有的Java对象实例不一定都在Java堆上分配内存
简单来讲就是，Java Hotspot 虚拟机可以分析新创建对象的使用范围，并决定是否在 Java 堆上分配内存的一项技术。
使用  开启逃逸分析：-XX:+DoEscapeAnalysis 关闭逃逸分析：-XX:-DoEscapeAnalysis 显示分析结果：-XX:+PrintEscapeAnalysis 逃逸分析技术在 Java SE 6u23+ 开始支持,并默认设置为启用状态  逃逸程度 逸分析的基本行为就是分析对象动态作用域,从不逃逸、方法逃逸到线程逃逸，称为对象由低到高的不同逃逸程度。
方法逃逸 当一个对象在方法中被定义后，它可能被外部方法所引用，例如作为调用参数传递到其他地方中，称为方法逃逸。
/*StringBuffer sb是一个方法内部变量，上述代码中直接将sb返回，这样这个StringBuffer有可能被其他方法所 *改变，这样它的作用域就不只是在方法内部，虽然它是一个局部变量，称其逃逸到了方法外部。甚至还有可能被外部线 *程访问到，譬如赋值给类变量或可以在其他线程中访问的实例变量，称为线程逃逸。 */  public static StringBuffer craeteStringBuffer(String s1, String s2) {  StringBuffer sb = new StringBuffer();  sb.append(s1);  sb.append(s2);  return sb;  }   //上述代码如果想要StringBuffer sb不逃出方法，可以这样写：  public static String createStringBuffer(String s1, String s2) {  StringBuffer sb = new StringBuffer();  sb."><meta property="og:type" content="article"><meta property="og:url" content="https://greycode.top/posts/jvm-javastack-escapeanalysis/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-05-26T16:02:00+00:00"><meta property="article:modified_time" content="2020-05-26T16:02:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="JVM逃逸分析技术"><meta name=twitter:description content="逃逸分析技术的日渐成熟,促使所有的Java对象实例不一定都在Java堆上分配内存
简单来讲就是，Java Hotspot 虚拟机可以分析新创建对象的使用范围，并决定是否在 Java 堆上分配内存的一项技术。
使用  开启逃逸分析：-XX:+DoEscapeAnalysis 关闭逃逸分析：-XX:-DoEscapeAnalysis 显示分析结果：-XX:+PrintEscapeAnalysis 逃逸分析技术在 Java SE 6u23+ 开始支持,并默认设置为启用状态  逃逸程度 逸分析的基本行为就是分析对象动态作用域,从不逃逸、方法逃逸到线程逃逸，称为对象由低到高的不同逃逸程度。
方法逃逸 当一个对象在方法中被定义后，它可能被外部方法所引用，例如作为调用参数传递到其他地方中，称为方法逃逸。
/*StringBuffer sb是一个方法内部变量，上述代码中直接将sb返回，这样这个StringBuffer有可能被其他方法所 *改变，这样它的作用域就不只是在方法内部，虽然它是一个局部变量，称其逃逸到了方法外部。甚至还有可能被外部线 *程访问到，譬如赋值给类变量或可以在其他线程中访问的实例变量，称为线程逃逸。 */  public static StringBuffer craeteStringBuffer(String s1, String s2) {  StringBuffer sb = new StringBuffer();  sb.append(s1);  sb.append(s2);  return sb;  }   //上述代码如果想要StringBuffer sb不逃出方法，可以这样写：  public static String createStringBuffer(String s1, String s2) {  StringBuffer sb = new StringBuffer();  sb."><link rel=stylesheet href=https://greycode.top/css/styles.94f653e9e151e28067a7c5dbbc4600cbd5a3c721e79faaf971e523c40f3b249b8e4f20bb57810dfffa8d559ca5c140fd56eb4cd9c0853113ad08e66afdb08bdd.css integrity="sha512-lPZT6eFR4oBnp8XbvEYAy9WjxyHnn6r5ceUjxA87JJuOTyC7V4EN//qNVZylwUD9VutM2cCFMROtCOZq/bCL3Q=="><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script>
<script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://greycode.top/images/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-JVLPYZM5G1"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-JVLPYZM5G1",{anonymize_ip:!1})}</script></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick='$("html, body").animate({scrollTop:0},"fast")' style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu><span id=nav><ul><li><a href=/>Home</a></li><li><a href=/posts>All posts</a></li><li><a href=/categories>Categories</a></li><li><a href=/tags>Tags</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=https://greycode.top/posts/spring-security-oauth-server-demo/ aria-label=Previous><i class="fas fa-chevron-left" aria-hidden=true onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class=icon href=https://greycode.top/posts/jvm-running-data-area/ aria-label=Next><i class="fas fa-chevron-right" aria-hidden=true onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up" aria-hidden=true onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class=icon href=# aria-label=Share><i class="fas fa-share-alt" aria-hidden=true onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fgreycode.top%2fposts%2fjvm-javastack-escapeanalysis%2f" aria-label=Facebook><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fgreycode.top%2fposts%2fjvm-javastack-escapeanalysis%2f&text=JVM%e9%80%83%e9%80%b8%e5%88%86%e6%9e%90%e6%8a%80%e6%9c%af" aria-label=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fgreycode.top%2fposts%2fjvm-javastack-escapeanalysis%2f&title=JVM%e9%80%83%e9%80%b8%e5%88%86%e6%9e%90%e6%8a%80%e6%9c%af" aria-label=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fgreycode.top%2fposts%2fjvm-javastack-escapeanalysis%2f&is_video=false&description=JVM%e9%80%83%e9%80%b8%e5%88%86%e6%9e%90%e6%8a%80%e6%9c%af" aria-label=Pinterest><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=JVM%e9%80%83%e9%80%b8%e5%88%86%e6%9e%90%e6%8a%80%e6%9c%af&body=Check out this article: https%3a%2f%2fgreycode.top%2fposts%2fjvm-javastack-escapeanalysis%2f" aria-label=Email><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fgreycode.top%2fposts%2fjvm-javastack-escapeanalysis%2f&title=JVM%e9%80%83%e9%80%b8%e5%88%86%e6%9e%90%e6%8a%80%e6%9c%af" aria-label=Pocket><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fgreycode.top%2fposts%2fjvm-javastack-escapeanalysis%2f&title=JVM%e9%80%83%e9%80%b8%e5%88%86%e6%9e%90%e6%8a%80%e6%9c%af" aria-label=reddit><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fgreycode.top%2fposts%2fjvm-javastack-escapeanalysis%2f&name=JVM%e9%80%83%e9%80%b8%e5%88%86%e6%9e%90%e6%8a%80%e6%9c%af&description=%e9%80%83%e9%80%b8%e5%88%86%e6%9e%90%e6%8a%80%e6%9c%af%e7%9a%84%e6%97%a5%e6%b8%90%e6%88%90%e7%86%9f%2c%e4%bf%83%e4%bd%bf%e6%89%80%e6%9c%89%e7%9a%84Java%e5%af%b9%e8%b1%a1%e5%ae%9e%e4%be%8b%e4%b8%8d%e4%b8%80%e5%ae%9a%e9%83%bd%e5%9c%a8Java%e5%a0%86%e4%b8%8a%e5%88%86%e9%85%8d%e5%86%85%e5%ad%98%0a%e7%ae%80%e5%8d%95%e6%9d%a5%e8%ae%b2%e5%b0%b1%e6%98%af%ef%bc%8cJava%20Hotspot%20%e8%99%9a%e6%8b%9f%e6%9c%ba%e5%8f%af%e4%bb%a5%e5%88%86%e6%9e%90%e6%96%b0%e5%88%9b%e5%bb%ba%e5%af%b9%e8%b1%a1%e7%9a%84%e4%bd%bf%e7%94%a8%e8%8c%83%e5%9b%b4%ef%bc%8c%e5%b9%b6%e5%86%b3%e5%ae%9a%e6%98%af%e5%90%a6%e5%9c%a8%20Java%20%e5%a0%86%e4%b8%8a%e5%88%86%e9%85%8d%e5%86%85%e5%ad%98%e7%9a%84%e4%b8%80%e9%a1%b9%e6%8a%80%e6%9c%af%e3%80%82%0a%e4%bd%bf%e7%94%a8%20%20%e5%bc%80%e5%90%af%e9%80%83%e9%80%b8%e5%88%86%e6%9e%90%ef%bc%9a-XX%3a%2bDoEscapeAnalysis%20%e5%85%b3%e9%97%ad%e9%80%83%e9%80%b8%e5%88%86%e6%9e%90%ef%bc%9a-XX%3a-DoEscapeAnalysis%20%e6%98%be%e7%a4%ba%e5%88%86%e6%9e%90%e7%bb%93%e6%9e%9c%ef%bc%9a-XX%3a%2bPrintEscapeAnalysis%20%e9%80%83%e9%80%b8%e5%88%86%e6%9e%90%e6%8a%80%e6%9c%af%e5%9c%a8%20Java%20SE%206u23%2b%20%e5%bc%80%e5%a7%8b%e6%94%af%e6%8c%81%2c%e5%b9%b6%e9%bb%98%e8%ae%a4%e8%ae%be%e7%bd%ae%e4%b8%ba%e5%90%af%e7%94%a8%e7%8a%b6%e6%80%81%20%20%e9%80%83%e9%80%b8%e7%a8%8b%e5%ba%a6%20%e9%80%b8%e5%88%86%e6%9e%90%e7%9a%84%e5%9f%ba%e6%9c%ac%e8%a1%8c%e4%b8%ba%e5%b0%b1%e6%98%af%e5%88%86%e6%9e%90%e5%af%b9%e8%b1%a1%e5%8a%a8%e6%80%81%e4%bd%9c%e7%94%a8%e5%9f%9f%2c%e4%bb%8e%e4%b8%8d%e9%80%83%e9%80%b8%e3%80%81%e6%96%b9%e6%b3%95%e9%80%83%e9%80%b8%e5%88%b0%e7%ba%bf%e7%a8%8b%e9%80%83%e9%80%b8%ef%bc%8c%e7%a7%b0%e4%b8%ba%e5%af%b9%e8%b1%a1%e7%94%b1%e4%bd%8e%e5%88%b0%e9%ab%98%e7%9a%84%e4%b8%8d%e5%90%8c%e9%80%83%e9%80%b8%e7%a8%8b%e5%ba%a6%e3%80%82%0a%e6%96%b9%e6%b3%95%e9%80%83%e9%80%b8%20%e5%bd%93%e4%b8%80%e4%b8%aa%e5%af%b9%e8%b1%a1%e5%9c%a8%e6%96%b9%e6%b3%95%e4%b8%ad%e8%a2%ab%e5%ae%9a%e4%b9%89%e5%90%8e%ef%bc%8c%e5%ae%83%e5%8f%af%e8%83%bd%e8%a2%ab%e5%a4%96%e9%83%a8%e6%96%b9%e6%b3%95%e6%89%80%e5%bc%95%e7%94%a8%ef%bc%8c%e4%be%8b%e5%a6%82%e4%bd%9c%e4%b8%ba%e8%b0%83%e7%94%a8%e5%8f%82%e6%95%b0%e4%bc%a0%e9%80%92%e5%88%b0%e5%85%b6%e4%bb%96%e5%9c%b0%e6%96%b9%e4%b8%ad%ef%bc%8c%e7%a7%b0%e4%b8%ba%e6%96%b9%e6%b3%95%e9%80%83%e9%80%b8%e3%80%82%0a%2f%2aStringBuffer%20sb%e6%98%af%e4%b8%80%e4%b8%aa%e6%96%b9%e6%b3%95%e5%86%85%e9%83%a8%e5%8f%98%e9%87%8f%ef%bc%8c%e4%b8%8a%e8%bf%b0%e4%bb%a3%e7%a0%81%e4%b8%ad%e7%9b%b4%e6%8e%a5%e5%b0%86sb%e8%bf%94%e5%9b%9e%ef%bc%8c%e8%bf%99%e6%a0%b7%e8%bf%99%e4%b8%aaStringBuffer%e6%9c%89%e5%8f%af%e8%83%bd%e8%a2%ab%e5%85%b6%e4%bb%96%e6%96%b9%e6%b3%95%e6%89%80%20%2a%e6%94%b9%e5%8f%98%ef%bc%8c%e8%bf%99%e6%a0%b7%e5%ae%83%e7%9a%84%e4%bd%9c%e7%94%a8%e5%9f%9f%e5%b0%b1%e4%b8%8d%e5%8f%aa%e6%98%af%e5%9c%a8%e6%96%b9%e6%b3%95%e5%86%85%e9%83%a8%ef%bc%8c%e8%99%bd%e7%84%b6%e5%ae%83%e6%98%af%e4%b8%80%e4%b8%aa%e5%b1%80%e9%83%a8%e5%8f%98%e9%87%8f%ef%bc%8c%e7%a7%b0%e5%85%b6%e9%80%83%e9%80%b8%e5%88%b0%e4%ba%86%e6%96%b9%e6%b3%95%e5%a4%96%e9%83%a8%e3%80%82%e7%94%9a%e8%87%b3%e8%bf%98%e6%9c%89%e5%8f%af%e8%83%bd%e8%a2%ab%e5%a4%96%e9%83%a8%e7%ba%bf%20%2a%e7%a8%8b%e8%ae%bf%e9%97%ae%e5%88%b0%ef%bc%8c%e8%ad%ac%e5%a6%82%e8%b5%8b%e5%80%bc%e7%bb%99%e7%b1%bb%e5%8f%98%e9%87%8f%e6%88%96%e5%8f%af%e4%bb%a5%e5%9c%a8%e5%85%b6%e4%bb%96%e7%ba%bf%e7%a8%8b%e4%b8%ad%e8%ae%bf%e9%97%ae%e7%9a%84%e5%ae%9e%e4%be%8b%e5%8f%98%e9%87%8f%ef%bc%8c%e7%a7%b0%e4%b8%ba%e7%ba%bf%e7%a8%8b%e9%80%83%e9%80%b8%e3%80%82%20%2a%2f%20%20public%20static%20StringBuffer%20craeteStringBuffer%28String%20s1%2c%20String%20s2%29%20%7b%20%20StringBuffer%20sb%20%3d%20new%20StringBuffer%28%29%3b%20%20sb.append%28s1%29%3b%20%20sb.append%28s2%29%3b%20%20return%20sb%3b%20%20%7d%20%20%20%2f%2f%e4%b8%8a%e8%bf%b0%e4%bb%a3%e7%a0%81%e5%a6%82%e6%9e%9c%e6%83%b3%e8%a6%81StringBuffer%20sb%e4%b8%8d%e9%80%83%e5%87%ba%e6%96%b9%e6%b3%95%ef%bc%8c%e5%8f%af%e4%bb%a5%e8%bf%99%e6%a0%b7%e5%86%99%ef%bc%9a%20%20public%20static%20String%20createStringBuffer%28String%20s1%2c%20String%20s2%29%20%7b%20%20StringBuffer%20sb%20%3d%20new%20StringBuffer%28%29%3b%20%20sb." aria-label=Tumblr><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fgreycode.top%2fposts%2fjvm-javastack-escapeanalysis%2f&t=JVM%e9%80%83%e9%80%b8%e5%88%86%e6%9e%90%e6%8a%80%e6%9c%af" aria-label="Hacker News"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div><div id=toc><nav id=TableOfContents><ul><li><a href=#使用>使用</a></li><li><a href=#逃逸程度>逃逸程度</a><ul><li><a href=#方法逃逸>方法逃逸</a></li><li><a href=#线程逃逸>线程逃逸</a></li></ul></li><li><a href=#逃逸分析优化>逃逸分析优化</a><ul><li><a href=#栈上分配stack-allocations>栈上分配（Stack Allocations）</a></li><li><a href=#标量替换scalar-replacement>标量替换（Scalar Replacement）</a></li><li><a href=#同步消除synchronization-elimination>同步消除（Synchronization Elimination）</a></li></ul></li></ul></nav></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">JVM逃逸分析技术</h1><div class=meta><div class=postdate><time datetime="2020-05-26 16:02:00 +0000 UTC" itemprop=datePublished>2020-05-26</time></div><div class=article-category><i class="fas fa-archive"></i>
<a class=category-link href=/categories/jvm>JVM</a></div><div class=article-tag><i class="fas fa-tag"></i>
<a class=tag-link href=/tags/jvm rel=tag>JVM</a></div></div></header><div class=content itemprop=articleBody><p>逃逸分析技术的日渐成熟,促使所有的Java对象实例不一定都在Java堆上分配内存</p><p>简单来讲就是，Java Hotspot 虚拟机可以分析<strong>新创建对象</strong>的使用范围，并决定是否在 Java 堆上分配内存的一项技术。</p><h2 id=使用>使用</h2><ul><li>开启逃逸分析：-XX:+DoEscapeAnalysis</li><li>关闭逃逸分析：-XX:-DoEscapeAnalysis</li><li>显示分析结果：-XX:+PrintEscapeAnalysis</li><li>逃逸分析技术在 Java SE 6u23+ 开始支持,并默认设置为启用状态</li></ul><h2 id=逃逸程度>逃逸程度</h2><p>逸分析的基本行为就是分析对象动态作用域,从<strong>不逃逸</strong>、<strong>方法逃逸</strong>到<strong>线程逃逸</strong>，称为对象<strong>由低到高的不同逃逸程度</strong>。</p><h3 id=方法逃逸>方法逃逸</h3><p>当一个对象在<strong>方法中</strong>被定义后，它可能被<strong>外部方法</strong>所引用，例如作为调用参数传递到其他地方中，称为<strong>方法逃逸</strong>。</p><div class=highlight><pre tabindex=0 style=color:#2f1e2e;background-color:#e7e9db;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8d8687>/*StringBuffer sb是一个方法内部变量，上述代码中直接将sb返回，这样这个StringBuffer有可能被其他方法所
</span></span></span><span style=display:flex><span><span style=color:#8d8687>*改变，这样它的作用域就不只是在方法内部，虽然它是一个局部变量，称其逃逸到了方法外部。甚至还有可能被外部线
</span></span></span><span style=display:flex><span><span style=color:#8d8687>*程访问到，譬如赋值给类变量或可以在其他线程中访问的实例变量，称为线程逃逸。
</span></span></span><span style=display:flex><span><span style=color:#8d8687>*/</span>
</span></span><span style=display:flex><span> <span style=color:#815ba4>public</span> <span style=color:#815ba4>static</span> StringBuffer <span style=color:#06b6ef>craeteStringBuffer</span><span style=color:#5bc4bf>(</span>String s1<span style=color:#5bc4bf>,</span> String s2<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>     StringBuffer sb <span style=color:#5bc4bf>=</span> <span style=color:#815ba4>new</span> StringBuffer<span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span>     sb<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>append</span><span style=color:#5bc4bf>(</span>s1<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>     sb<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>append</span><span style=color:#5bc4bf>(</span>s2<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>     <span style=color:#815ba4>return</span> sb<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span> <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> <span style=color:#8d8687>//上述代码如果想要StringBuffer sb不逃出方法，可以这样写：
</span></span></span><span style=display:flex><span><span style=color:#8d8687></span> <span style=color:#815ba4>public</span> <span style=color:#815ba4>static</span> String <span style=color:#06b6ef>createStringBuffer</span><span style=color:#5bc4bf>(</span>String s1<span style=color:#5bc4bf>,</span> String s2<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>     StringBuffer sb <span style=color:#5bc4bf>=</span> <span style=color:#815ba4>new</span> StringBuffer<span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span>     sb<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>append</span><span style=color:#5bc4bf>(</span>s1<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>     sb<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>append</span><span style=color:#5bc4bf>(</span>s2<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>     <span style=color:#815ba4>return</span> sb<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>toString</span><span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span> <span style=color:#5bc4bf>}</span>
</span></span></code></pre></div><h3 id=线程逃逸>线程逃逸</h3><ul><li>当一个对象在<strong>方法中</strong>被定义后，它可能被<strong>外部线程</strong>访问到，譬如赋值给可以在其他线程中访问的实例变量，这种称为<strong>线程逃逸</strong>。</li></ul><h2 id=逃逸分析优化>逃逸分析优化</h2><p>如果能<strong>证明一个对象不会逃逸到方法或线程之外</strong>（换句话说是别的方法或线程无法通过任何途径访问到这个对象），或者<strong>逃逸程度比较低</strong>（只逃逸出方法而不会逃逸出线程），则可能为这个对象实例<strong>采取不同程度的优化</strong></p><h3 id=栈上分配stack-allocations>栈上分配（Stack Allocations）</h3><ul><li>如果确定一个对象<strong>不会逃逸出线程之外</strong>，那让这个对象在<strong>栈上分配内存</strong>将会是一个很不错的主意，对象所占用的内存空间就可以<strong>随栈帧出栈而销毁</strong>。</li><li>由于复杂度等原因，HotSpot中目前暂时还没有做这项优化，但一些其他的虚拟机（如Excelsior JET）使用了这项优化。</li><li>栈上分配可以支持方法逃逸，但不能支持线程逃逸。</li></ul><h3 id=标量替换scalar-replacement>标量替换（Scalar Replacement）</h3><ul><li>若一个数据已经无法再分解成更小的数据来表示了，Java虚拟机中的原始数据类型（int、long等数值类型及reference类型等）都不能再进一步分解了，那么这些数据就可以被称为<strong>标量</strong>。相对的，如果一个数据可以继续分解，那它就被称为<strong>聚合量（Aggregate）</strong>，Java中的对象就是典型的聚合量。</li><li>-XX:+EliminateAllocations 开启标量替换(jdk8默认开启)</li><li>-XX:+PrintEliminateAllocations 查看标量的替换情况</li><li>如果把一个Java对象拆散，根据程序访问的情况，将其用到的成员变量恢复为原始类型来访问，这个过程就称为<strong>标量替换</strong></li><li>假如逃逸分析能够证明一个对象<strong>不会被方法外部访问</strong>，并且这个对象可以被拆散，那么程序真正执行的时候将<strong>可能不去创建这个对象</strong>，而改为直接创建它的若干个被这个方法使用的<strong>成员变量</strong>来代替。</li><li>标量替换可以视作<strong>栈上分配的一种特例</strong>，实现更简单（不用考虑整个对象完整结构的分配），但对逃逸程度的要求更高，它<strong>不允许对象逃逸出方法范围内</strong>。</li></ul><h3 id=同步消除synchronization-elimination>同步消除（Synchronization Elimination）</h3><blockquote><p>也叫锁消除</p></blockquote><ul><li>+XX:+EliminateLocks 开启同步消除(jdk8默认开启)</li><li>线程同步本身是一个相对耗时的过程，如果逃逸分析能够确定一个变量<strong>不会逃逸出线程</strong>，无法被其他线程访问，那么这个变量的读写肯定就不会有竞争，对这个变量实施的<strong>同步措施</strong>也就可以<strong>安全地消除掉</strong>。</li><li>比如常用的线程安全类:<code>StringBuffer</code>,<code>HashTable</code>,<code>Vector</code>等.</li></ul></div></article><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Home</a></li><li><a href=/posts>All posts</a></li><li><a href=/categories>Categories</a></li><li><a href=/tags>Tags</a></li></ul></div><div id=toc-footer style=display:none><nav id=TableOfContents><ul><li><a href=#使用>使用</a></li><li><a href=#逃逸程度>逃逸程度</a><ul><li><a href=#方法逃逸>方法逃逸</a></li><li><a href=#线程逃逸>线程逃逸</a></li></ul></li><li><a href=#逃逸分析优化>逃逸分析优化</a><ul><li><a href=#栈上分配stack-allocations>栈上分配（Stack Allocations）</a></li><li><a href=#标量替换scalar-replacement>标量替换（Scalar Replacement）</a></li><li><a href=#同步消除synchronization-elimination>同步消除（Synchronization Elimination）</a></li></ul></li></ul></nav></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fgreycode.top%2fposts%2fjvm-javastack-escapeanalysis%2f" aria-label=Facebook><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fgreycode.top%2fposts%2fjvm-javastack-escapeanalysis%2f&text=JVM%e9%80%83%e9%80%b8%e5%88%86%e6%9e%90%e6%8a%80%e6%9c%af" aria-label=Twitter><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fgreycode.top%2fposts%2fjvm-javastack-escapeanalysis%2f&title=JVM%e9%80%83%e9%80%b8%e5%88%86%e6%9e%90%e6%8a%80%e6%9c%af" aria-label=Linkedin><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fgreycode.top%2fposts%2fjvm-javastack-escapeanalysis%2f&is_video=false&description=JVM%e9%80%83%e9%80%b8%e5%88%86%e6%9e%90%e6%8a%80%e6%9c%af" aria-label=Pinterest><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=JVM%e9%80%83%e9%80%b8%e5%88%86%e6%9e%90%e6%8a%80%e6%9c%af&body=Check out this article: https%3a%2f%2fgreycode.top%2fposts%2fjvm-javastack-escapeanalysis%2f" aria-label=Email><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fgreycode.top%2fposts%2fjvm-javastack-escapeanalysis%2f&title=JVM%e9%80%83%e9%80%b8%e5%88%86%e6%9e%90%e6%8a%80%e6%9c%af" aria-label=Pocket><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fgreycode.top%2fposts%2fjvm-javastack-escapeanalysis%2f&title=JVM%e9%80%83%e9%80%b8%e5%88%86%e6%9e%90%e6%8a%80%e6%9c%af" aria-label=reddit><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fgreycode.top%2fposts%2fjvm-javastack-escapeanalysis%2f&name=JVM%e9%80%83%e9%80%b8%e5%88%86%e6%9e%90%e6%8a%80%e6%9c%af&description=%e9%80%83%e9%80%b8%e5%88%86%e6%9e%90%e6%8a%80%e6%9c%af%e7%9a%84%e6%97%a5%e6%b8%90%e6%88%90%e7%86%9f%2c%e4%bf%83%e4%bd%bf%e6%89%80%e6%9c%89%e7%9a%84Java%e5%af%b9%e8%b1%a1%e5%ae%9e%e4%be%8b%e4%b8%8d%e4%b8%80%e5%ae%9a%e9%83%bd%e5%9c%a8Java%e5%a0%86%e4%b8%8a%e5%88%86%e9%85%8d%e5%86%85%e5%ad%98%0a%e7%ae%80%e5%8d%95%e6%9d%a5%e8%ae%b2%e5%b0%b1%e6%98%af%ef%bc%8cJava%20Hotspot%20%e8%99%9a%e6%8b%9f%e6%9c%ba%e5%8f%af%e4%bb%a5%e5%88%86%e6%9e%90%e6%96%b0%e5%88%9b%e5%bb%ba%e5%af%b9%e8%b1%a1%e7%9a%84%e4%bd%bf%e7%94%a8%e8%8c%83%e5%9b%b4%ef%bc%8c%e5%b9%b6%e5%86%b3%e5%ae%9a%e6%98%af%e5%90%a6%e5%9c%a8%20Java%20%e5%a0%86%e4%b8%8a%e5%88%86%e9%85%8d%e5%86%85%e5%ad%98%e7%9a%84%e4%b8%80%e9%a1%b9%e6%8a%80%e6%9c%af%e3%80%82%0a%e4%bd%bf%e7%94%a8%20%20%e5%bc%80%e5%90%af%e9%80%83%e9%80%b8%e5%88%86%e6%9e%90%ef%bc%9a-XX%3a%2bDoEscapeAnalysis%20%e5%85%b3%e9%97%ad%e9%80%83%e9%80%b8%e5%88%86%e6%9e%90%ef%bc%9a-XX%3a-DoEscapeAnalysis%20%e6%98%be%e7%a4%ba%e5%88%86%e6%9e%90%e7%bb%93%e6%9e%9c%ef%bc%9a-XX%3a%2bPrintEscapeAnalysis%20%e9%80%83%e9%80%b8%e5%88%86%e6%9e%90%e6%8a%80%e6%9c%af%e5%9c%a8%20Java%20SE%206u23%2b%20%e5%bc%80%e5%a7%8b%e6%94%af%e6%8c%81%2c%e5%b9%b6%e9%bb%98%e8%ae%a4%e8%ae%be%e7%bd%ae%e4%b8%ba%e5%90%af%e7%94%a8%e7%8a%b6%e6%80%81%20%20%e9%80%83%e9%80%b8%e7%a8%8b%e5%ba%a6%20%e9%80%b8%e5%88%86%e6%9e%90%e7%9a%84%e5%9f%ba%e6%9c%ac%e8%a1%8c%e4%b8%ba%e5%b0%b1%e6%98%af%e5%88%86%e6%9e%90%e5%af%b9%e8%b1%a1%e5%8a%a8%e6%80%81%e4%bd%9c%e7%94%a8%e5%9f%9f%2c%e4%bb%8e%e4%b8%8d%e9%80%83%e9%80%b8%e3%80%81%e6%96%b9%e6%b3%95%e9%80%83%e9%80%b8%e5%88%b0%e7%ba%bf%e7%a8%8b%e9%80%83%e9%80%b8%ef%bc%8c%e7%a7%b0%e4%b8%ba%e5%af%b9%e8%b1%a1%e7%94%b1%e4%bd%8e%e5%88%b0%e9%ab%98%e7%9a%84%e4%b8%8d%e5%90%8c%e9%80%83%e9%80%b8%e7%a8%8b%e5%ba%a6%e3%80%82%0a%e6%96%b9%e6%b3%95%e9%80%83%e9%80%b8%20%e5%bd%93%e4%b8%80%e4%b8%aa%e5%af%b9%e8%b1%a1%e5%9c%a8%e6%96%b9%e6%b3%95%e4%b8%ad%e8%a2%ab%e5%ae%9a%e4%b9%89%e5%90%8e%ef%bc%8c%e5%ae%83%e5%8f%af%e8%83%bd%e8%a2%ab%e5%a4%96%e9%83%a8%e6%96%b9%e6%b3%95%e6%89%80%e5%bc%95%e7%94%a8%ef%bc%8c%e4%be%8b%e5%a6%82%e4%bd%9c%e4%b8%ba%e8%b0%83%e7%94%a8%e5%8f%82%e6%95%b0%e4%bc%a0%e9%80%92%e5%88%b0%e5%85%b6%e4%bb%96%e5%9c%b0%e6%96%b9%e4%b8%ad%ef%bc%8c%e7%a7%b0%e4%b8%ba%e6%96%b9%e6%b3%95%e9%80%83%e9%80%b8%e3%80%82%0a%2f%2aStringBuffer%20sb%e6%98%af%e4%b8%80%e4%b8%aa%e6%96%b9%e6%b3%95%e5%86%85%e9%83%a8%e5%8f%98%e9%87%8f%ef%bc%8c%e4%b8%8a%e8%bf%b0%e4%bb%a3%e7%a0%81%e4%b8%ad%e7%9b%b4%e6%8e%a5%e5%b0%86sb%e8%bf%94%e5%9b%9e%ef%bc%8c%e8%bf%99%e6%a0%b7%e8%bf%99%e4%b8%aaStringBuffer%e6%9c%89%e5%8f%af%e8%83%bd%e8%a2%ab%e5%85%b6%e4%bb%96%e6%96%b9%e6%b3%95%e6%89%80%20%2a%e6%94%b9%e5%8f%98%ef%bc%8c%e8%bf%99%e6%a0%b7%e5%ae%83%e7%9a%84%e4%bd%9c%e7%94%a8%e5%9f%9f%e5%b0%b1%e4%b8%8d%e5%8f%aa%e6%98%af%e5%9c%a8%e6%96%b9%e6%b3%95%e5%86%85%e9%83%a8%ef%bc%8c%e8%99%bd%e7%84%b6%e5%ae%83%e6%98%af%e4%b8%80%e4%b8%aa%e5%b1%80%e9%83%a8%e5%8f%98%e9%87%8f%ef%bc%8c%e7%a7%b0%e5%85%b6%e9%80%83%e9%80%b8%e5%88%b0%e4%ba%86%e6%96%b9%e6%b3%95%e5%a4%96%e9%83%a8%e3%80%82%e7%94%9a%e8%87%b3%e8%bf%98%e6%9c%89%e5%8f%af%e8%83%bd%e8%a2%ab%e5%a4%96%e9%83%a8%e7%ba%bf%20%2a%e7%a8%8b%e8%ae%bf%e9%97%ae%e5%88%b0%ef%bc%8c%e8%ad%ac%e5%a6%82%e8%b5%8b%e5%80%bc%e7%bb%99%e7%b1%bb%e5%8f%98%e9%87%8f%e6%88%96%e5%8f%af%e4%bb%a5%e5%9c%a8%e5%85%b6%e4%bb%96%e7%ba%bf%e7%a8%8b%e4%b8%ad%e8%ae%bf%e9%97%ae%e7%9a%84%e5%ae%9e%e4%be%8b%e5%8f%98%e9%87%8f%ef%bc%8c%e7%a7%b0%e4%b8%ba%e7%ba%bf%e7%a8%8b%e9%80%83%e9%80%b8%e3%80%82%20%2a%2f%20%20public%20static%20StringBuffer%20craeteStringBuffer%28String%20s1%2c%20String%20s2%29%20%7b%20%20StringBuffer%20sb%20%3d%20new%20StringBuffer%28%29%3b%20%20sb.append%28s1%29%3b%20%20sb.append%28s2%29%3b%20%20return%20sb%3b%20%20%7d%20%20%20%2f%2f%e4%b8%8a%e8%bf%b0%e4%bb%a3%e7%a0%81%e5%a6%82%e6%9e%9c%e6%83%b3%e8%a6%81StringBuffer%20sb%e4%b8%8d%e9%80%83%e5%87%ba%e6%96%b9%e6%b3%95%ef%bc%8c%e5%8f%af%e4%bb%a5%e8%bf%99%e6%a0%b7%e5%86%99%ef%bc%9a%20%20public%20static%20String%20createStringBuffer%28String%20s1%2c%20String%20s2%29%20%7b%20%20StringBuffer%20sb%20%3d%20new%20StringBuffer%28%29%3b%20%20sb." aria-label=Tumblr><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fgreycode.top%2fposts%2fjvm-javastack-escapeanalysis%2f&t=JVM%e9%80%83%e9%80%b8%e5%88%86%e6%9e%90%e6%8a%80%e6%9c%af" aria-label="Hacker News"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu-toggle class=icon href=# onclick='return $("#nav-footer").toggle(),!1' aria-label=Menu><i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=toc-toggle class=icon href=# onclick='return $("#toc-footer").toggle(),!1' aria-label=TOC><i class="fas fa-list fa-lg" aria-hidden=true></i> TOC</a>
<a id=share-toggle class=icon href=# onclick='return $("#share-footer").toggle(),!1' aria-label=Share><i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; 2022 Greycode's Blog</div><div class=footer-right><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>All posts</a></li><li><a href=/categories>Categories</a></li><li><a href=/tags>Tags</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>
<script src=/js/code-copy.js></script>
<script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]]},svg:{fontCache:"global"}}</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></html>